---
title: "01-SiteLevel"
author: "Galina M. Jönsson"
date: "12/10/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---
## Notes (remove before sub)
* Main question1: is type really a predictor and not an effect? or isit a proxy for human activity?  
* Main question2: remind me whats novel about this ms pl  
* See further Qs where I've written "TOM" in below text  
* The figures used in the thesis are not publication standard but I'll reproduce once you know which journal you're going for  
* In short for your understanding:  the optimal model is a type of mixture model known as a zero inflated negative binomial (**ZINB**) GLMM. The underlying process is such that in the count process (i.e. of *Bulinus* in the field), you sometimes counted zero snails because the snails don’t like the covariates, or due to that you didn't have time to sieve through the whole freakin pond and/or snails were difficult to observe. Hence the resulting survey data fall into three categories: snails were collected, snails were present but not collected (false zeroes) and snails were not present and not collected (true zeroes). ZINBs are called mixture models because the zeros are modelled as coming from two different processes: the binomial process and the count process. the binomial GLM models the probability of measuring a false positive versus all other types of data (counts and true zeros), whilst the count process (non zeros and true zeros) is modelled by a  negative binomial (ZINB) GLMM. 
* Note that glmmTMB() fits the model using the Laplace approximation - this should probably be mentined in the ms... or not... hmm   





#### Useful links
* https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html  
* https://cran.r-project.org/web/packages/DHARMa/DHARMa.pdf#page=29&zoom=100,133,242  
* https://cran.r-project.org/web/packages/glmmTMB/vignettes/glmmTMB.pdf  






## The data

Load and tidy the data

```{r loadNclean-data}
### load data
siteDF <- read.csv("../Data/rawData/survey_site_raw.csv")


### Subset columns of interest
keeps <- c("USI", "shehia", "survey", "wbtype2", "wlevel", "BgBn_pres", "BgBn_number", "temp", "ph", "cond", "tds", "sal", "flow", "depth","Bulinus_xeno", "Sh", "Sh_pres", "Sh_prev", "lat_cor", "lon_cor", "survey_date")

siteDF <- siteDF[keeps]



### Change variables to appropriate classes
siteDF$site <- as.factor(siteDF$USI)
siteDF$survey <- as.factor(siteDF$survey)
siteDF$shehia <- as.factor(siteDF$shehia)
siteDF$wbtype2 <- as.factor(siteDF$wbtype2)
siteDF$wlevel <- factor(siteDF$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
siteDF$flow <- factor(siteDF$flow, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
siteDF$depth <- factor(siteDF$depth, ordered = TRUE, 
                                levels = c("1", "2", "3"))
siteDF$BgBn_pres <- as.factor(siteDF$BgBn_pres)


### remove surveys that had nonsensical pH readings
# We will specify those readings as to not remove potential NAs in the column
# Waw5 S3 pH=3.05
siteDF <- siteDF[!(siteDF$ph==3.05),]
# Ole8 S1 pH=3.10
siteDF <- siteDF[!(siteDF$ph==3.10),]
# Ole7 S1 ph=4.67
siteDF <- siteDF[!(siteDF$ph==4.67),]


### remove surveys that were not conducted
siteDF <- siteDF[complete.cases(siteDF[ , "BgBn_number"]),]
```


### Visualise response variable
Number of *Bulinus* individuals collected per survey
```{r respvar, cache=TRUE, message=FALSE}
require(ggplot2)
p <- ggplot(siteDF,aes(x=BgBn_number))+
  stat_count(position="identity",alpha=0.5,width = 1)+theme()
p <- p + labs(y = "Density",x = "Number of snails")
p
```



\n

The response variable is heavily zero inflated. I.e. most surveys did not collect any *Bulinus* individuals.


### Test for collinearity between explanatory variables
\n
\n
#### Explanatory variables of potential interest
**TOM** can you modify these explanations so that they are correct please? 
* **wlevel** -> water level    
* **wbtype2** -> water body type: either permanent or temporary    
* **survey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2    
* **temp** -> water temperature   
* **cond** -> conductivity; indirect measure of water chemistry   
* **ph** -> potentially correlated with conductivity   
* **tds** -> total dissolved substances; likely correlated with cond and/or sal    
* **sal** -> water salinity; likely correlated with tds, pH and/or sal   
* **flow** -> water flow in four categories   
* **depth** -> water depth in three categories; likely correlated with wbtype2   


Potential collinearity between quantitative explanatory variables is tested using the Kendall rank coefficient to establish whether variables are statistically dependent. This test is non-parametric, i.e. does not rely on any assumptions on the distributions of the variables. Collinearity between qualitative and quantitative explanatory variables is visually examined using box plots. 
```{r collinearity-explanVars-test, message=FALSE, warning=FALSE, cache=TRUE}
# Load required packages
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")


### Quantitative explanatory variables: Kendall rank coefficient
chart.Correlation(siteDF[,c("temp", "ph", "cond", "tds", "sal")], 
                  histogram=TRUE, pch=19, method = "kendall")
# Each significance level is associated to a symbol : p-values(0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)


### Qualitative and quantitative explanatory variables

## Qualitative variables and temp
ggarrange(ggplot(siteDF, aes(x = wbtype2, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = flow, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = depth, y = temp)) + geom_boxplot() + rremove("x.text"), 
          labels = c("wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)

## Qualitative variables and pH
ggarrange(ggplot(siteDF, aes(x = wbtype2, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = flow, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = depth, y = ph)) + geom_boxplot() + rremove("x.text"), 
          labels = c("wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)

## Qualitative variables and cond
ggarrange(ggplot(siteDF, aes(x = wbtype2, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = flow, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = depth, y = cond)) + geom_boxplot() + rremove("x.text"), 
          labels = c("wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)
```




\n

* Temperature and pH are negatively correlated (p<0.001), but the correlation coefficient is -0.2 suggesting it is weak and likely unimportant.  
* pH is very weakly positively correlated with total dissolved substances (p=0.05) and salinity (p=0.05)   
* Conductivity is positively correlated with total dissolved substances (p=0.001) and salinity (p=0.001)   
* Total dissolved substances is positively correlated salinity (p=0.001)

\n
Given that conductivity, total dissolved substances and salinity show high correlation coefficients close to 1, only conductivity will be considered from hereon as this variable was measured most precisely. \n
\n
\n
Among the qualitative and quantitative explanatory variables, only conductivity and flow appear correlated. 


## Model fitting and selection

The variables used in initial model selection are as follows: 

#### Response variable 
* **BgBn_number** -> The number of *Bulinus* individuals collected per survey  


#### Explanatory variables of potential interest
* **wlevel** -> water level    
* **wbtype2** -> waterbody type: either permanent or temporary    
* **survey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2; this vaiable will not be dropped in any model simplification as it accounts for **known differences in snail abundance** (TOM!?) between different seasons.  
* **temp** -> water temperature   
* **cond** -> conductivity; indirect measure of water chemistry   
* **ph** -> potentially correlated with conductivity   
* **flow** -> water flow in four categories   
* **depth** -> water depth in three categories; likely correlated with wbtype2   


#### Random factors   
* **shehia** -> regions/wards on Pemba
* **site** -> sites within shesias; hence, site is nested within shehia in models


Given the variables described above, we must use a type of generalised linear mixed effects model to test what effects the number of snails collected per survey. 

### Distributions
First, we test which distribution best fits the data in a maximal model (i.e. including all potential explanatory variables, two-way interaction terms between quantitative variables and the random factors). As the response variable is count data, we test both the Poisson and the negative binomial distribution. Moreover, as the response variable is zero inflated, we also test whether the inclusion of a zero inflation parameter improves model fit for the Poisson and the negative binomial distribution. Model fit is evaluated based on visual inspection of QQ plots, AIC and likelihood ratio tests (variance structure).

```{r glmer-BgBn_number-Distributions, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
require(devtools)
#devtools::install_github("glmmTMB/glmmTMB/glmmTMB")
require(glmmTMB)
require(DHARMa)
require(lmtest)

## load (installing if necessary) the checkpoint package
#while (!require("checkpoint")) install.packages("checkpoint")
## retrieve build date of installed version of TMB
#bd <- as.character(asDateBuilt(packageDescription("TMB",fields="Built")))
#oldrepo <- getOption("repos")
#setSnapshot(bd)
#install.packages("Matrix")
#options(repos=oldrepo) ## restore original repo


######################################################################
######################## Poisson Distribution ########################
######################################################################

# Fit maximal model
glmm.poisson <- glmer(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           cond * ph + flow + depth +
                          (1|shehia/site), data=siteDF, family = "poisson")

# test for zero-inflation
testZeroInflation(simulateResiduals(glmm.poisson,  n = 1000)) # Evidence suggesting zero inflation 

# Plot fit
plot(simulateResiduals(glmm.poisson,  n = 1000), rank = TRUE)


######################################################################
################ Zero Inflated Poisson Distribution ##################
######################################################################

# Fit maximal model
glmm.ZIpoisson <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           cond * ph + flow + depth +
                          (1|shehia/site),  data=siteDF,
                         ziformula=~1, # one zero inflation parameter applying to all observations
                         family=poisson)

# Plot fit
plot(simulateResiduals(glmm.ZIpoisson,  n = 1000), rank = TRUE)





######################################################################
################# Negative Binomial Distribution #####################
######################################################################

# Fit maximal model
glmm.nb <- glmer.nb(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           cond * ph + flow + depth +
                          (1|shehia/site),  data=siteDF)
# test for zero-inflation
testZeroInflation(simulateResiduals(glmm.nb,  n = 1000)) # No evidence for zero inflation 

# Plot fit
plot(simulateResiduals(glmm.nb,  n = 1000), rank = TRUE)



######################################################################
########## Zero Inflated Negative Binomial Distribution ##############
######################################################################

# Fit maximal model
glmm.ZInb <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           cond * ph + flow + depth +
                          (1|shehia/site), data=siteDF,
                         ziformula = ~1,
                         family = nbinom2)

# Plot fit
plot(simulateResiduals(glmm.ZInb,  n = 1000), rank = TRUE)




######################################################################
########################## Model Comparison ##########################
######################################################################
require(lmtest)

### Likelihood ratio tests

# Poison vs zero inflated Poisson
lrtest(glmm.poisson, glmm.ZIpoisson)

# Negative binomial vs  zero inflated negative binomial
lrtest(glmm.nb, glmm.ZInb)


### AIC
AIC(glmm.poisson, glmm.ZIpoisson, glmm.nb, glmm.ZInb)
```


\n

The inclusion of a zero inflation parameter for the Poisson distribution does not reach convergence; hence, the likelihood ratio test cannot be preformed and AIC cannot be calculated; however, visual inspection of QQ plots suggests that the zero inflation parameter may improve model fit. The negative binomial distribution fits the data better than the Poisson distribution, as evident from AIC (1737 vs 5704) and visual inspection of QQ plots. The inclusion of a zero inflation parameter improves model fit for the negative binomial distribution, as evident from AIC (1728 vs. 1737), visual inspection of QQ plots and the likelihood ratio test being significant (i.e. the the less restrictive model (the one with more variables/glmm.ZInb) fits the data significantly better than the more restrictive model(glmm.nb)) Hence, a zero inflated negative binomial distribution gives the best fit and will be used to fit the data.



\n
\n
\n
\n
\n

### Variables
Now we test which of the explanatory variables can be dropped from the maximal model. We drop each term in turn and select the optimal model using AIC and likelihood ratio test. Note that we fit the models using a subset of the surveys which have measurements for all explanatory variables. We start by only basing our decising on AICs. 
```{r glmer-BgBn_number-nb-min-models1, message=FALSE, warning=FALSE, cache=TRUE}

# Fit maximal model
glmm.ZInb.max <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           cond * ph + flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)





### AIC

# Use drop1 to find the highest AIC (i.e. "worst") model
stats::drop1(glmm.ZInb.max)
# The model in which the term "ph * cond" is dropped has the highest AIC


# Fit a minimal model dropping "ph * cond"
glmm.ZInb.min.1 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



### Likelihood ratio test 
require(lmtest)
lrtest(glmm.ZInb.max, glmm.ZInb.min.1)
```

\n

The model, in which "ph * cond" was dropped from the maximal model (glmm.ZInb.min.1) had the greatest AIC, and although the likelihood ratio test was significant  (p=0.003577), we have no reason to believe there is an interaction between the variables. Therefore, we drop the "ph * cond" term. 

As these test are approximate and the AICs of models with and without "ph * cond" are very similar, we test whether dropping another term improves model fit further. 

```{r glmer-BgBn_number-nb-min-models2, message=FALSE, warning=FALSE, cache=TRUE}
# Fit a minimal model dropping "wbtype2"
glmm.ZInb.min.1.1 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Fit a minimal model dropping "wlevel"
glmm.ZInb.min.1.2 <- glmmTMB(BgBn_number ~ wbtype2 + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", 
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Fit a minimal model dropping "temp * ph"
glmm.ZInb.min.1.3 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Fit a minimal model dropping "temp * cond"
glmm.ZInb.min.1.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Fit a minimal model dropping "flow"
glmm.ZInb.min.1.5 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Fit a minimal model dropping "depth"
glmm.ZInb.min.1.6 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + temp * cond +
                           flow +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.1, glmm.ZInb.min.1); lrtest(glmm.ZInb.min.1.2, glmm.ZInb.min.1)
lrtest(glmm.ZInb.min.1.3, glmm.ZInb.min.1); lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1)
lrtest(glmm.ZInb.min.1.5, glmm.ZInb.min.1); lrtest(glmm.ZInb.min.1.6, glmm.ZInb.min.1)

# AIC
AIC(glmm.ZInb.min.1, glmm.ZInb.min.1.1, glmm.ZInb.min.1.2, glmm.ZInb.min.1.3, glmm.ZInb.min.1.4, glmm.ZInb.min.1.5, glmm.ZInb.min.1.6)
```
Dropping the "temp * cond " interaction term (glmm.ZInb.min.1.4) does not reduce model fit according to the likelihood ratio test (p=0.06) and the resulting model gives the lowest AIC. As such, we drop the "temp * cond " interaction term and test which variable to drop next


```{r glmer-BgBn_number-nb-min-models3, message=FALSE, warning=FALSE, cache=TRUE}
# Fit a minimal model dropping "temp * cond"
glmm.ZInb.min.1.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Fit a minimal model dropping "wbtype2"
glmm.ZInb.min.1.4.1 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond + 
                           temp * ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop wlevel
glmm.ZInb.min.1.4.2 <- glmmTMB(BgBn_number ~ wbtype2 + survey +
                         temp + ph + cond + 
                           temp * ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop cond
glmm.ZInb.min.1.4.3 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph +
                           temp * ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop "temp * ph"
glmm.ZInb.min.1.4.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "flow"
glmm.ZInb.min.1.4.5 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           temp * ph +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "depth"
glmm.ZInb.min.1.4.6 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           temp * ph +
                           flow +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Model comparison

# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.1); lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.2)
lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.3); lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.4)
lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.5); lrtest(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.6)

# AIC
AIC(glmm.ZInb.min.1.4, glmm.ZInb.min.1.4.1, glmm.ZInb.min.1.4.2, glmm.ZInb.min.1.4.3, glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.5, glmm.ZInb.min.1.4.6)
```

\n

Dropping the "temp * ph" interaction term (glmm.ZInb.min.1.4.4) does not reduce model fit according to the likelihood ratio test (p=0.5251) and the resulting model gives the lowest AIC (1728.171). As such, we drop the "temp * ph" interaction term and test whether the model fit is improved by dropping further terms


```{r glmer-BgBn_number-nb-min-models4, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "temp * ph"
glmm.ZInb.min.1.4.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "wbtype2"
glmm.ZInb.min.1.4.4.1 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "wlevel"
glmm.ZInb.min.1.4.4.2 <- glmmTMB(BgBn_number ~ wbtype2 + survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "temp"
glmm.ZInb.min.1.4.4.3 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "ph"
glmm.ZInb.min.1.4.4.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "cond"
glmm.ZInb.min.1.4.4.5 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "flow"
glmm.ZInb.min.1.4.4.6 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "depth"
glmm.ZInb.min.1.4.4.7 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         temp + ph + cond +
                           flow + 
                          (1|shehia/site), 
                         contrasts=list(wbtype2="contr.sum", 
                                        wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)




### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.1); lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.2)
lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.3); lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.4)
lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.5); lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.6)
lrtest(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.7)

# AIC
AIC(glmm.ZInb.min.1.4.4, glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.2, glmm.ZInb.min.1.4.4.3,
    glmm.ZInb.min.1.4.4.4, glmm.ZInb.min.1.4.4.5, glmm.ZInb.min.1.4.4.6, glmm.ZInb.min.1.4.4.7)
```


Dropping the "wbtype2" term (glmm.ZInb.min.1.4.4.1) does not reduce model fit according to the likelihood ratio test (p=0.1847) and the resulting model gives the lowest AIC among the reduced models (1727.931). As such, we drop the "wbtype2" term and test whether the model fit is improved by dropping further terms


```{r glmer-BgBn_number-nb-min-models5, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "wbtype2"
glmm.ZInb.min.1.4.4.1 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "wlevel"
glmm.ZInb.min.1.4.4.1.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "temp"
glmm.ZInb.min.1.4.4.1.2 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         ph + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "ph"
glmm.ZInb.min.1.4.4.1.3 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + cond +
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)




# Drop "cond"
glmm.ZInb.min.1.4.4.1.4 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + 
                           flow + depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)




# Drop "flow"
glmm.ZInb.min.1.4.4.1.5 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)




# Drop "depth"
glmm.ZInb.min.1.4.4.1.6 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                           flow + 
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        flow="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wbtype2", "wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "flow" ,"depth")]),],
                         ziformula = ~1,
                         family = nbinom2)






### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.1); lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.2)
lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.3); lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.4)
lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.5); lrtest(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.6)

# AIC
AIC(glmm.ZInb.min.1.4.4.1, glmm.ZInb.min.1.4.4.1.1, glmm.ZInb.min.1.4.4.1.2, glmm.ZInb.min.1.4.4.1.3,
    glmm.ZInb.min.1.4.4.1.4, glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.6)
```


Dropping the "flow" term (glmm.ZInb.min.1.4.4.1.5) does not reduce model fit according to the likelihood ratio test (p=0.1041) and the resulting model gives the lowest AIC among the reduced models (1728.091). As such, we drop the "flow" term and test whether the model fit is improved by dropping further terms


```{r glmer-BgBn_number-nb-min-models6, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "flow"
glmm.ZInb.min.1.4.4.1.5 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "wlevel"
glmm.ZInb.min.1.4.4.1.5.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "temp"
glmm.ZInb.min.1.4.4.1.5.2 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         ph + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "ph"
glmm.ZInb.min.1.4.4.1.5.3 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + cond +
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "cond"
glmm.ZInb.min.1.4.4.1.5.4 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + 
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "depth"
glmm.ZInb.min.1.4.4.1.5.5 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + cond +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "cond",
                                                            "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)








### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.1); lrtest(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.2)
lrtest(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.3); lrtest(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.4)
lrtest(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.5)

# AIC
AIC(glmm.ZInb.min.1.4.4.1.5, glmm.ZInb.min.1.4.4.1.5.1, glmm.ZInb.min.1.4.4.1.5.2, glmm.ZInb.min.1.4.4.1.5.3,
    glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.5)
```

Likelihood ratio tests show that the less reduced model fits the data better than any of the reduced models. However, at a certain point in model reduction this is not a surprising result from these tests. AIC values tell a different story: dropping the terms "wlevel" (glmm.ZInb.min.1.4.4.1.5.1) and "cond" (glmm.ZInb.min.1.4.4.1.5.4) result in the smallest AICs. We drop "cond" as the difference is marginally in favor of keeping "wlevels". 

```{r glmer-BgBn_number-nb-min-models7, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "cond"
glmm.ZInb.min.1.4.4.1.5.4 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + 
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "wlevel"
glmm.ZInb.min.1.4.4.1.5.4.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + 
                           depth +
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "temp"
glmm.ZInb.min.1.4.4.1.5.4.2 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         ph + 
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "ph"
glmm.ZInb.min.1.4.4.1.5.4.3 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + 
                           depth +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum",
                                        depth="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "depth"
glmm.ZInb.min.1.4.4.1.5.4.4 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + 
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph", "depth")]),],
                         ziformula = ~1,
                         family = nbinom2)








### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.4.1)
lrtest(glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.4.2)
lrtest(glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.4.3)
lrtest(glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.4.4)

# AIC
AIC(glmm.ZInb.min.1.4.4.1.5.4, glmm.ZInb.min.1.4.4.1.5.4.1, glmm.ZInb.min.1.4.4.1.5.4.2, glmm.ZInb.min.1.4.4.1.5.4.3, glmm.ZInb.min.1.4.4.1.5.4.4)
```

Dropping the "wlevel" term (glmm.ZInb.min.1.4.4.1.5.4.1) does not reduce model fit according to the likelihood ratio test (0.5007) and the resulting model gives the lowest AIC (1723.675) among the reduced models. However, as "wlevel" and "depth" are  correlated and depth is a more indirect measure (in addition to also not reducing model fit according to the likelihood ratio test and gives a reasonably low AIC (1726.958); hence, we drop the "depth" term (glmm.ZInb.min.1.4.4.1.5.4.1) and test whether the model fit is improved by dropping further terms.




```{r glmer-BgBn_number-nb-min-models8, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "depth"
glmm.ZInb.min.1.4.4.1.5.4.4 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp + ph + 
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "wlevel"
glmm.ZInb.min.1.4.4.1.5.4.4.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + 
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "temp"
glmm.ZInb.min.1.4.4.1.5.4.4.2 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         ph + 
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "ph"
glmm.ZInb.min.1.4.4.1.5.4.4.3 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         temp +
                          (1|shehia/site), 
                         contrasts=list(wlevel="contr.sum", 
                                        survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)





### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4.1.5.4.4, glmm.ZInb.min.1.4.4.1.5.4.4.1)
lrtest(glmm.ZInb.min.1.4.4.1.5.4.4, glmm.ZInb.min.1.4.4.1.5.4.4.2)
lrtest(glmm.ZInb.min.1.4.4.1.5.4.4, glmm.ZInb.min.1.4.4.1.5.4.4.3)


# AIC
AIC(glmm.ZInb.min.1.4.4.1.5.4.4, glmm.ZInb.min.1.4.4.1.5.4.4.1, glmm.ZInb.min.1.4.4.1.5.4.4.2, glmm.ZInb.min.1.4.4.1.5.4.4.3)
```

__________________________________________________
**OLD** Delete!!
Although likelihood ratio tests and AIC values point towards that model fit is improved by dropping the "wlevel" term; however, we argue that one term accounting for differences in the water volume between the sites sampled should be included in a final model given it's well-documented importance on the study species (**TOM** talking some shit here so please fill in haha). The difference in AIC between keeping and removing the term "temp" is marginal and we will therefore use with the "glmm.ZInb.min.1.4.4.1.5.4.4" model. 


**Ended here: talk to Tom about whether wlevel really is needed and not indirectly accounted for by the survey variable? The test say that it should go and model results are much stronger (i.e. lower p-values) when its removed. When its kept in the model, none of the variables clearly come out significant.**
__________________________________________________




__________________________________________________
**NEW** 
Actually, I'm making the decision to remove "wlevel" and I'm saying that it's accounted for in "survey"!!!!!!


Although we argue that water level should be accounted, we have not shown any evidence for this variable improving model fit. As such, we argue that differences in water level are indirectly accounted for in the "survey" variable. Removing the "wlevel" variable gived the lowest AIC (1733.529) and likelihood ratio test indicate that it does not improve model fit (p=0.5546). Hence we remove the term "wlevel": 
```{r glmer-BgBn_number-nb-min-models9, message=FALSE, warning=FALSE, cache=TRUE}
# Drop "wlevel"
glmm.ZInb.min.1.4.4.1.5.4.4.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + 
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop "temp"
glmm.ZInb.min.1.4.4.1.5.4.4.1.1 <- glmmTMB(BgBn_number ~ survey +
                         ph + 
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop "ph"
glmm.ZInb.min.1.4.4.1.5.4.4.1.2 <- glmmTMB(BgBn_number ~ survey +
                         temp +
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)





### Model comparison
# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.1.4.4.1.5.4.4.1, glmm.ZInb.min.1.4.4.1.5.4.4.1.1)
lrtest(glmm.ZInb.min.1.4.4.1.5.4.4.1, glmm.ZInb.min.1.4.4.1.5.4.4.1.2)


# AIC
AIC(glmm.ZInb.min.1.4.4.1.5.4.4.1, glmm.ZInb.min.1.4.4.1.5.4.4.1.1, glmm.ZInb.min.1.4.4.1.5.4.4.1.2)
```

AIC values clearly indicate that we are now finished with our model selection proces and will not remove further terms. 


## Test for autocorrelation
Test whether there is evidence for spatial or temporal autocorrelation. 

### Temporal autocorrelation 

Here we test for temporal autocorrelation using Julian dates; hence, assuming that day within a year is a key factor whilst the year itself isn't. The data used here was collected over two years (2017 and 2018) which **TOM** do you know whether they were somewhat similar or at least not extremely different weather-wise? 
```{r glmm.ZInb.min.1.4.4.1.5.4.4.1-autocorrelation-temp, cache=TRUE, message=FALSE}
require(DHARMa)
require(glmmTMB)

### Refit final model
glmm.ZInb.min.1.4.4.1.5.4.4.1 <- glmmTMB(BgBn_number ~ survey +
                         temp + ph + 
                          (1|shehia/site), 
                         contrasts=list(survey="contr.sum"),
                     data=siteDF[complete.cases(siteDF[ , c("wlevel",
                                                            "survey", "temp", 
                                                            "ph")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Load the raw data
mydata <- (siteDF[complete.cases(siteDF[, c("BgBn_number", "survey", 
                                           "temp", "shehia", "site", "lat_cor", "lon_cor", "survey_date", "ph")]),])

# Fix three dates that were entered incorrectly: month 17 instead of 07
mydata$survey_date <- gsub("20/17/2018","20/07/2018",mydata$survey_date)

# make a copy of survey_date that is a date class
mydata$survey_date2 <- as.Date(mydata$survey_date, format = "%d/%m/%Y")

# Change all years to 2017 (see reasoning above)
require(lubridate)
year(mydata$survey_date2) <- 2017

# Create a column with Julian dates
mydata$myjulian <- julian(mydata$survey_date2, origin = as.Date("2017-01-01"))


res <- simulateResiduals(glmm.ZInb.min.1.4.4.1.5.4.4.1)

# testing grouped residuals 
res <- recalculateResiduals(res, group <- mydata$myjulian)
testTemporalAutocorrelation(res, time <- unique(mydata$myjulian))
```

We get a p-value greater than 0.05 and can therefore reject the alternative hypothesis (true autocorrelation is not 0) and assume that our "survey" variable satisfactory accounts for any temporal autocorrelation.  

### Spatial autocorrelation 

```{r glmm.ZInb.min.1.4.4.1.5.4.4.1-autocorrelation-spatial, cache=TRUE, message=FALSE}
## Spatial
require(DHARMa)
E <- simulateResiduals(glmm.ZInb.min.1.4.4.1.5.4.4.1,  n = 1000)

E2 <- resid(glmm.ZInb.min.1.4.4.1.5.4.4.1)
require(gstat)
require(sp)
mydata <- (siteDF[complete.cases(siteDF[, c("BgBn_number", "survey", 
                                           "temp", "shehia", "site", "lat_cor", "lon_cor", "survey_date", "ph")]),])
mydata <- data.frame(E2, mydata$lon_cor, mydata$lat_cor)
coordinates(mydata) <- c("mydata.lon_cor","mydata.lat_cor")
bubble(mydata, "E2", col = c("black","grey"),
main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")

testSpatialAutocorrelation(glmm.ZInb.min.1.4.4.1.5.4.4.1, x = mydata$lat_cor, y = mydata$lon_cor)
testSpatialAutocorrelation(E, x = mydata$lat_cor, y = mydata$lon_cor)

Vario1 <- variogram(E2 ~ 1, mydata)
plot(Vario1)
```
We get a p-value greater than 0.05 and can therefore reject the alternative hypothesis (existence of Spatial autocorrelation that is not accounted for by the nested random factors shehia and site)




## Results

### Overview
First, we look at the summary of our model and then use a type III Wald chisquare test to test whether any of the explanatory variables affect the number of *Bulinus* individuals collected per survey. Thereafter, we plot the effects of the explanatory variables before going through them one by one (below). 
```{r glmm.ZInb.min.1.4.4.1.5.4.4.1-Overview, cache=TRUE, message=FALSE, warning=FALSE}
require(glmmTMB)
require(car)
require(effects)

summary(glmm.ZInb.min.1.4.4.1.5.4.4.1)
car::Anova(glmm.ZInb.min.1.4.4.1.5.4.4.1, type="III")

effects_ok <- (requireNamespace("effects") && getRversion() >= "3.6.0")
if (effects_ok) {
(ae <- allEffects(glmm.ZInb.min.1.4.4.1.5.4.4.1))
plot(ae)
}
```
\n
\n

**TOM** Recall that this is a mixture model! 
The summary shows that:
* The logistic (Zero-inflation) model for the false zeros is statistically significant (p=2.33e-05 ***)  



The type III Wald chisquare test shows:
* survey has a clearly significant effect on the number of snails, ph has a marginally significant effect and temperature has no statistically significant effect  




### Temperature
The effect plots indicate that there may be a negative effect on snail numbers with increasing temperatures but this is not statistically significant (X2 = 1.54, df = 1, p = 0.214) within the range and with the data used here
\n
\n






### pH
pH has a positive effect on snail numbers; however, the chi square test is only marginally statistically significant (X2 = 0.51, df = 1, p = 0.067) within the range and with the data used here
\n
\n





### Survey

Nearly all variation in the snails number of collected was explained by the survey (X2 = 20.2658, df = 3, p = 0.0001495)! These results are quite boring as survey is certainly proxy for something else but the data and models were not able to extract which (if any) of the environmental variables used here that caused the variation in snail abundance.  Predicted responses are that on average, 52.4, 17.6, 11.5 and 14.6 snails were present in ponds during survey S1, S2, S3 and S4, respectively. However, note that the confidence intervals are very large indicating much variation within surveys. A post-hoc pairwise Tukey Contrast test shows that there is no statistically significant difference between survey 2, 3 and 4, whilst all three aforementioned surveys are statistically different (have fewer snails) than survey 1. 
\n
```{r glmm.ZInb.min.1.4.4.1.5.4.4.1-survey, cache=TRUE}
require(emmeans)
require(multcomp)

emmeans(glmm.ZInb.min.1.4.4.1.5.4.4.1, c("survey"), data = siteDF[complete.cases(siteDF[ , c("temp")]),], type = "response")

tukeySurvey <- glht(glmm.ZInb.min.1.4.4.1.5.4.4.1, linfct = mcp(survey = "Tukey"))
summary(tukeySurvey)
```


\n