---
title: "01-SiteLevel"
author: "Galina M. JÃ¶nsson"
date: "12/10/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---


## The data
```{r loadNclean-data}
### load data
siteDF <- read.csv("../Data/TempTom/df2_new.csv")



### Subset columns of interest
keeps <- c("USI", "shehia", "survey", "type", "wbtype2", "wlevel", "BgBn_pres", "BgBn_number", "temp", "ph", "cond", "Bulinus_xeno", "Sh", "Sh_pres", "Sh_prev", "lat_cor", "lon_cor", "survey_date")

siteDF <- siteDF[keeps]



### Change variables to appropriate classes
siteDF$site <- as.factor(siteDF$USI)
siteDF$survey <- as.factor(siteDF$survey)
siteDF$shehia <- as.factor(siteDF$shehia)
siteDF$type <- factor(siteDF$type, ordered = TRUE, 
                                levels = c("HNR", "HD", "LNR", "LD"))
siteDF$wbtype2 <- as.factor(siteDF$wbtype2)
siteDF$wlevel <- factor(siteDF$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
siteDF$BgBn_pres <- as.factor(siteDF$BgBn_pres)



### remove surveys that were not conducted
siteDF <- siteDF[complete.cases(siteDF[ , "BgBn_number"]),]
```


### Visualise response variable
Number of **Bulinus** individuals collected per survey
```{r respvar, cache=TRUE, message=FALSE}
require(ggplot2)
p <- ggplot(siteDF,aes(x=BgBn_number))+
  stat_count(position="identity",alpha=0.5,width = 1)+theme()
p <- p + labs(y = "Density",x = "Number of snails")
p
```



\n

The response variable is heavily zero inflated. I.e. most surveys did not collect any **Bulinus** individuals.


### Test for collinearity between explanatory variables
**Environmental variables of interest**   
- wlevel -> water level   
- wbtype2 -> waterbody type: either permanent or temporary   
- syrvey -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2   
- temp -> water temperature  
- cond -> conductivity; indirect measure of water chemistry  
- ph -> potentially correlated with conductivity  
- type -> human response to treatment; whether people got reinfected quickly or not; four categories   


Potential collinearity between quantitative explanatory variables is tested using the Kendall rank coefficient to establish whether variables are statistically dependent. This test is non-parametric, i.e. does not rely on any assumptions on the distributions of the variables. Collinearity between qualitative and quantitative explanatory variables is visually examined using box plots. 
```{r collinearity-explanVars-test, message=FALSE, warning=FALSE, cache=TRUE}
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")



### Quantitative explanatory variables: Kendall rank coefficient
chart.Correlation(siteDF[,c("temp", "ph", "cond")], 
                  histogram=TRUE, pch=19, method = "kendall")



### Qualitative and quantitative explanatory variables

## Qualitative variables and temp
ggarrange(ggplot(siteDF, aes(x = type, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wbtype2, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = temp)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = temp)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel"),
          ncol = 2, nrow = 2)

## Qualitative variables and pH
ggarrange(ggplot(siteDF, aes(x = type, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wbtype2, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = ph)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = ph)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel"),
          ncol = 2, nrow = 2)

## Qualitative variables and pH
ggarrange(ggplot(siteDF, aes(x = type, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wbtype2, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = survey, y = cond)) + geom_boxplot(),
          ggplot(siteDF, aes(x = wlevel, y = cond)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel"),
          ncol = 2, nrow = 2)
```




\n

Temperature and pH are negatively correlated (p<0.001). From hereon, only Temperature will be used in analyses. Temperature and conductivity show some positive sorrelation although not statistically significant (p=0.1).




## Model selection

The variables used in initial model selection are as follows: 

**Response variable**   
- BgBn_number -> The number of **Bulinus** individuals collected per survey  


**Explanatory variables**   
- wlevel -> water level   
- wbtype2 -> waterbody type: either permanent or temporary   
- syrvey -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2; this vaiable will not be dropped in any model simplification as it accounts for **known differences in snail abundance** (TOM!?) between different seasons.    
- temp -> water temperature  
- cond -> conductivity; indirect measure of water chemistry  
- type -> human response to treatment; whether people got reinfected quickly or not; four categories  

**Random factors**   
- shehia -> regions/wards on Pemba
- site -> sites within shesias; hence, site is nested within shehia in models


Given the variables described above, we must use a type of generalised linear mixed effects model to test what effects the number of snails collected per survey. 

### Distributions
First, we test which distribution best fits the date in a maximal model (i.e. including all explanatory variables and the random factors). As the response variable is count data, we test both the Poisson and the negative binomial distribution. Moreover, as the response variable is zero inflated, we also test whether the inclusion of a zero inflation parameter improves model fit for the Poisson and the negative binomial distribution. Model fit is evaluated based on visual inspection of QQ plots, AIC and likelihood ratio tests (variance structure).

```{r glmer-BgBn_number-Distributions, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
library(arm)
require(glmmTMB)
require(DHARMa)
require(lmtest)

######################################################################
######################## Poisson Distribution ########################
######################################################################

# Fit maximal model
glmm.poisson <- glmer(BgBn_number ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(cond) +
                 (1|shehia/site), data=siteDF, family = "poisson")

# test for zero-inflation
testZeroInflation(simulateResiduals(glmm.poisson,  n = 1000)) # Evidence suggesting zero inflation 

# Plot fit
plot(simulateResiduals(glmm.poisson,  n = 1000), rank = TRUE)


######################################################################
################ Zero Inflated Poisson Distribution ##################
######################################################################

# Fit maximal model
glmm.ZIpoisson <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), data=siteDF,
                         ziformula=~1, # one zero inflation parameter applying to all observations
                         family=poisson)

# Plot fit
plot(simulateResiduals(glmm.ZIpoisson,  n = 1000), rank = TRUE)





######################################################################
################# Negative Binomial Distribution #####################
######################################################################

# Fit maximal model
glmm.nb <- glmer.nb(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), data=siteDF)
# test for zero-inflation
testZeroInflation(simulateResiduals(glmm.nb,  n = 1000)) # No evidence for zero inflation 

# Plot fit
plot(simulateResiduals(glmm.nb,  n = 1000), rank = TRUE)



######################################################################
########## Zero Inflated Negative Binomial Distribution ##############
######################################################################

# Fit maximal model
glmm.ZInb <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), data=siteDF,
                         ziformula = ~1,
                         family = nbinom2)

# Plot fit
plot(simulateResiduals(glmm.ZInb,  n = 1000), rank = TRUE)






### Model comparison

require(lmtest)
lrtest(glmm.poisson, glmm.ZIpoisson)
lrtest(glmm.nb, glmm.poisson)
lrtest(glmm.nb, glmm.ZInb)
AIC(glmm.poisson, glmm.ZIpoisson, glmm.nb, glmm.ZInb)
```


\n

The negative binomial distribution clearly fits the data better than the Poisson distribution, as evident from AIC values (XX) and visual inspection of qq plots. The inclusion of a zero inflation parameter improves model fit for both the Poisson distribution and negative binomial distribution. As such, a zero inflated negative binomial distribution gives the best fit and will be used form hereon. 




\n
\n
\n
\n
\n

##### Minimising model
Now we test which of the explanatory variables can be dropped from the maximal model. We drop each term in turn and select the optimal model using the likelihood ratio test and AIC. Note that we fit the models using a subset of the surveys which have measurements for all explanatory variables.

```{r glmer-BgBn_number-nb-min-models1, message=FALSE, warning=FALSE, cache=TRUE}
# Fit maximal model
glmm.ZInb.max <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), 
                     data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop wbtype2
glmm.ZInb.min.1 <- glmmTMB(BgBn_number ~ wlevel + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), 
                      data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop wlevel
glmm.ZInb.min.2 <- glmmTMB(BgBn_number ~ wbtype2 + type + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), 
                      data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop type
glmm.ZInb.min.3 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         arm::rescale(temp) + arm::rescale(cond) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         family = nbinom2)

# Drop temp
glmm.ZInb.min.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(cond) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop cond
glmm.ZInb.min.5 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp", "cond")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Model comparison

# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.max, glmm.ZInb.min.1); lrtest(glmm.ZInb.max, glmm.ZInb.min.2)
lrtest(glmm.ZInb.max, glmm.ZInb.min.3); lrtest(glmm.ZInb.max, glmm.ZInb.min.4)
lrtest(glmm.ZInb.max, glmm.ZInb.min.5)

# AIC
AIC(glmm.ZInb.max, glmm.ZInb.min.1, glmm.ZInb.min.2, glmm.ZInb.min.3, glmm.ZInb.min.4, glmm.ZInb.min.5)
```

\n


The model, in which "cond" was dropped from the count data model (glmm.ZInb.min.5) had an associated p-value of 0.9106 and although it did not have the lowest AIC (1740), little difference in AIC values between models was observed, therefore we drop this term. 

As these test are approximate and the AICs of models with and without "cond" are very similar, we see whether dropping another term improves model fit further. 

```{r glmer-BgBn_number-nb-min-models2, message=FALSE, warning=FALSE, cache=TRUE}
# Refit glmm.ZInb.min.5
glmm.ZInb.min.5 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)



# Drop wbtype2
glmm.ZInb.min.5.1 <- glmmTMB(BgBn_number ~ wlevel + type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)


# Drop wlevel
glmm.ZInb.min.5.2 <- glmmTMB(BgBn_number ~ wbtype2 + type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop type
glmm.ZInb.min.5.3 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop temp
glmm.ZInb.min.5.4 <- glmmTMB(BgBn_number ~ wbtype2 + wlevel + type + survey +
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Model comparison

# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.5, glmm.ZInb.min.5.1); lrtest(glmm.ZInb.min.5, glmm.ZInb.min.5.2)
lrtest(glmm.ZInb.min.5, glmm.ZInb.min.5.3); lrtest(glmm.ZInb.min.5, glmm.ZInb.min.5.4)

# AIC
AIC(glmm.ZInb.min.5, glmm.ZInb.min.5.1, glmm.ZInb.min.5.2, glmm.ZInb.min.5.3, glmm.ZInb.min.5.4)
```

\n


Likelihood ratio tests revealed that the model, in which "wlevel" was dropped from the count data model (glmm.ZInb.min.5.2) gave an associated p-value of 0.8239 *BUT also the lowest* AIC (1746.647). However, dropping "wbtype2" gave a p-value of 0.5574 (and both wbtype 2 and wlevel are highely likely to be correlated) so we decide to keep "wlevel" and drop "wbtype2", and test whether dropping another term improves model fit further.  


```{r glmer-BgBn_number-nb-min-models3, message=FALSE, warning=FALSE, cache=TRUE}
# Drop wlevel
glmm.ZInb.min.5.1.1 <- glmmTMB(BgBn_number ~ type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop type
glmm.ZInb.min.5.1.2 <- glmmTMB(BgBn_number ~ wlevel + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)

# Drop temp
glmm.ZInb.min.5.1.3 <- glmmTMB(BgBn_number ~ wlevel + type + survey +
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Model comparison

# Likelihood ratio tests
require(lmtest)
lrtest(glmm.ZInb.min.5.1, glmm.ZInb.min.5.1.1); lrtest(glmm.ZInb.min.5.1, glmm.ZInb.min.5.1.2)
lrtest(glmm.ZInb.min.5.1, glmm.ZInb.min.5.1.3)

# AIC
AIC(glmm.ZInb.min.5.1, glmm.ZInb.min.5.1.1, glmm.ZInb.min.5.1.2, glmm.ZInb.min.5.1.3)
```

Likelihood ratio tests revealed that the model, in which "wlevel" was dropped from the count data model (glmm.ZInb.min.5.2) gave an associated p-value of 0.8057 and the lowest AIC (1735.668). Therefore, we also drop "wlevel", making our final model glmm.ZInb.min.5.1.1




## Test spatiotemporal autocorrelation. 
Test whether there is evidence for spatial or temporal autocorrelation. 

### Temporal autocorrelation 

Here we test for temporal autocorrelation using Julian dates; hence, assuming that day within a year is a key factor whilst the year itself isn't. The data used here was collected over two years (2017 and 2018) which **TOM** do you know whehther they were somewhat similar or at least not extremely different wether-wise? 
```{r glmm.ZInb.min.5.1.1-autocorrelation-temp, cache=TRUE, message=FALSE}
require(DHARMa)

### Refit final model
glmm.ZInb.min.5.1.1 <- glmmTMB(BgBn_number ~ type + survey +
                         arm::rescale(temp) + 
                          (1|shehia/site), 
                         data=siteDF[complete.cases(siteDF[ , c("temp")]),],
                         ziformula = ~1,
                         family = nbinom2)


### Load the raw data
mydata <- (siteDF[complete.cases(siteDF[, c("BgBn_number", "survey", 
                                           "temp", "shehia", "site", "lat_cor", "lon_cor", "survey_date")]),])

# Fix three dates that were entered incorrectly: month 17 instead of 07
mydata$survey_date <- gsub("20/17/2018","20/07/2018",mydata$survey_date)

# make a copy of survey_date that is a date class
mydata$survey_date2 <- as.Date(mydata$survey_date, format = "%d/%m/%Y")

# Change all years to 2017 (see reasoning above)
require(lubridate)
year(mydata$survey_date2) <- 2017

# Create a column with Julian dates
mydata$myjulian <- julian(mydata$survey_date2, origin = as.Date("2017-01-01"))


res = simulateResiduals(glmm.ZInb.min.5.1.1)

require(glmmTMB)
# testing grouped residuals 
res = recalculateResiduals(res, group = mydata$myjulian)
testTemporalAutocorrelation(res, time = unique(mydata$myjulian))
```



```{r glmm.ZInb.min.5.1.1-autocorrelation-spatial, cache=TRUE, message=FALSE}
## Spatial
require(DHARMa)
E <- simulateResiduals(glmm.ZInb.min.5.1.1,  n = 1000)

E2 <- resid(glmm.ZInb.min.5.1.1)
require(gstat)
require(sp)
mydata <- (siteDF[complete.cases(siteDF[, c("BgBn_number", "type", "survey",
                                           "temp", "shehia", "site", "lat_cor", "lon_cor", "survey_date")]),])
mydata <- data.frame(E2, mydata$lon_cor, mydata$lat_cor)
coordinates(mydata) <- c("mydata.lon_cor","mydata.lat_cor")
bubble(mydata, "E2", col = c("black","grey"),
main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")

testSpatialAutocorrelation(glmm.ZInb.min.5.1.1, x = mydata$lat_cor, y = mydata$lon_cor)
testSpatialAutocorrelation(E, x = mydata$lat_cor, y = mydata$lon_cor)

Vario1 <- variogram(E2 ~ 1, mydata)
plot(Vario1)
```


First I'll do a quick overview and then go through factor by factor
#### Overview

```{r glmm.ZInb.min.5.1.1-Overview, cache=TRUE, eval=FALSE}
require(car)
car::Anova(glmm.ZInb.min.5.1.1,type="III")

effects_ok <- (requireNamespace("effects") && getRversion() >= "3.6.0")
if (effects_ok) {
(ae <- allEffects(glmm.ZInb.min.5.1.1))
plot(ae)
}

(ae <- allEffects(glmm.ZInb.min.5.1.1))
plot(ae)

require(effects)
plot(allEffects(glmm.ZInb.min.5.1.1))
summary(glmm.ZInb.min.3)
```
\n
\n

#### Temperature
**temp**: Among the temperatures tested here (range: 22.33-37.40C) increasing temperatures have a statistically significant negative effect on snail abundance. After back-transforming, (exp(-0.17426) = 0.8400784; exp((exp(-0.17426+0.08534))-0.8400784) = 0.0748404), the effect of temperature on snial abundnace is such that with every one degree increase in temperature, a survey will on average have 0.8400784 (+-0.0748404) snails, i.e. on average -15.99552% (+-8.908729%) snails with every one degree C increase in temperature *(these were caclated as follows: (exp(-0.17426)-1)x100, and (exp(0.08534)-1)x100)* 
\n
\n




#### Water level
**wlevel**: The effect of water level on snail abundance is statistically significantly linear and negative (since the wlevel.L term is significant whilst the wlevel.Q term (water level quadratic) is not). I.e. the effect of water level on snail abundance follows this equation: exp(8.48248) + wlevel.L x 0.3626526 (that last number is from exp(-1.01431)). In other words, ON AVERAGE, there is a -63.73474% ((exp(-1.01431)-1)*100) DECREASE FROM "1" to "2", and from "2" to "3". HOWEVER, although the model says that is a statistically significant negative trend, snail abundance is not statistically different between the three water level factors tested here (cos its ecology and varies etc etc). See that SEs and Confidence limits overlap below. Not a problem tho because overall, you know that there is a statistically significant negative trends going from "1" to "2" to "3" :) 
\n
\n
```{r glmm.nb.min.3-wlevel, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(glmm.ZInb.min.3, c("wlevel"), data = siteDF, type = "response")
```
\n
\n

#### Type
**Type**: The effect of type on snail abundance is statistically significantly negatively linear AND negatively quadratic! (since the Type.L and Type.Q terms are significant). In other words, going from "HNR" to "HD" to "LNR" to "LD", snail abindance decreases and this decrease accelerates at a certain point (thus the significant quadratic term). It is obvious from the plots above and when comparing individual factor levels (see below) that "HNR", "HD" and "LNR" are not statistically different from each other BUT "LD" has lower snail abundance than any of the other three "types" and its statistically significant in terms of non-overlapping SEs/CLs. 
```{r glmm.nb.min.3-type, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(glmm.nb.min.3, c("type"), data = siteDF, type = "response")
```


#### Survey
**Survey**: survey 2, 3 and 4 are stat diff from survey 1 according to the mdoel (see summary(glmm.nb.min.3) above) and thre three surveys have FEWER snails than survey 1. Comparing survey 2, 3 and 4 (see SEs and CLs below) it's cear that there is not a statistically significant difference between snail abundance among suveys 2, 3 and 4 (which is in line with top plot too).
\n
```{r glmm.nb.min.3-survey, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(glmm.nb.min.3, c("survey"), data = siteDF, type = "response")
```


\n