---
title: "02-SnailLevel"
author: "Galina M. Jönsson"
date: "16/10/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

## Tidy and format raw data

Load and tidy the data. These analyses are based on the data sets, each of which contains data on different levels: snail-level, survey-level and Shehia-level. We therefore start by loading each one in turn and assigning all variables within a data set the correct class.

### Raw data
```{r load-data, cache=TRUE, warning=FALSE, message=FALSE}
#############################################################################
####### Snail-level data set - test result for infection per snail ##########
#############################################################################

# Load data set
snailRaw <- read.csv("../Data/rawData/snail_xeno_raw.csv")

## Assign variables appropriate classes
snailRaw$`snail_id`<-as.factor(snailRaw$`snail_id`)
snailRaw$`site`<-as.factor(snailRaw$`site`)
snailRaw$`survey`<-as.factor(snailRaw$`survey`)
snailRaw$`shehia`<-as.factor(snailRaw$`shehia`)
snailRaw$`type`<-as.factor(snailRaw$`type`)
snailRaw$`zest_arm`<-as.factor(snailRaw$`zest_arm`)
snailRaw$`survey_site`<-as.factor(snailRaw$`survey_site`)
snailRaw$`survey_shehia`<-as.factor(snailRaw$`survey_shehia`)
snailRaw$`wbtype`<-as.factor(snailRaw$`wbtype`)
snailRaw$`wbtype2`<-as.integer(snailRaw$`wbtype2`)
snailRaw$`assumed_Bulinus_spp_site`<-as.factor(snailRaw$`assumed_Bulinus_spp_site`)
snailRaw$`ITS-1-2-F_outcome`<-as.factor(snailRaw$`ITS_1_2_F_outcome`)
snailRaw$prepat_schisto_sp<-as.factor(snailRaw$prepat_schisto_sp)
snailRaw$prepat_Sh<-as.factor(snailRaw$prepat_Sh)
snailRaw$prepat_Sb<-as.factor(snailRaw$prepat_Sb)
snailRaw$prepat_ShSb<-as.factor(snailRaw$prepat_ShSb)
snailRaw$prepat_Schisto<-as.factor(snailRaw$prepat_Schisto)
snailRaw$Sh_all<-as.character(snailRaw$Sh_all)
snailRaw$Sh_all<-as.integer(snailRaw$Sh_all)
snailRaw$Sb_all<-as.character(snailRaw$Sb_all)
snailRaw$Sb_all<-as.integer(snailRaw$Sb_all)
snailRaw$'ITSF_2_outcome'<-as.factor(snailRaw$'ITSF_2_outcome')
snailRaw$'conf_Bulinus_sp'<-as.factor(snailRaw$'conf_Bulinus_sp')
snailRaw$'Bulinus_haplo'<-as.factor(snailRaw$'Bulinus_haplo')
snailRaw$patent_Sh<-as.factor(snailRaw$patent_Sh)
snailRaw$patent_Sb<-as.factor(snailRaw$patent_Sb)
snailRaw$patent_Schisto<-as.factor(snailRaw$patent_Schisto)





#############################################################################
#### Survey-level data set - environmental variables + human activities #####
#############################################################################

# Load data set
surveyRaw <- read.csv("../Data/rawData/survey_site_raw.csv")

## Assign variables appropriate classes
surveyRaw$`site`<-as.factor(surveyRaw$`USI`)
surveyRaw$`survey`<-as.factor(surveyRaw$`survey`)
surveyRaw$`shehia`<-as.factor(surveyRaw$`shehia`)
surveyRaw$`type`<-as.factor(surveyRaw$`type`)
surveyRaw$`zest_arm`<-as.factor(surveyRaw$`zest_arm`)
surveyRaw$`survey_site`<-as.factor(surveyRaw$`survey_site`)
surveyRaw$`survey_shehia`<-as.factor(surveyRaw$`survey_shehia`)
surveyRaw$`wbtype`<-as.factor(surveyRaw$`wbtype`)
surveyRaw$`wbtype2`<-as.integer(surveyRaw$`wbtype2`)
surveyRaw$`wlevel`<-as.factor(surveyRaw$`wlevel`)
surveyRaw$`BgBn_pres`<-as.factor(surveyRaw$`BgBn_pres`)
surveyRaw$`cerc_sp`<-as.factor(surveyRaw$`cerc_sp`)
surveyRaw$`flow`<-as.factor(surveyRaw$`flow`)
surveyRaw$`depth`<-as.factor(surveyRaw$`depth`)
surveyRaw$`Bfor_pres`<-as.factor(surveyRaw$`Bfor_pres`)
surveyRaw$`Lym_pres`<-as.factor(surveyRaw$`Lym_pres`)
surveyRaw$`Mel_pres`<-as.factor(surveyRaw$`Mel_pres`)
surveyRaw$`Cleo_pres`<-as.factor(surveyRaw$`Cleo_pres`)
surveyRaw$`Pila_pres`<-as.factor(surveyRaw$`Pila_pres`)
surveyRaw$`Lan_pres`<-as.factor(surveyRaw$`Lan_pres`)
surveyRaw$`Thiara_pres`<-as.factor(surveyRaw$`Thiara_pres`)
surveyRaw$`other_snail`<-as.factor(surveyRaw$`other_snail`)
surveyRaw$`Lilies`<-as.factor(surveyRaw$`Lilies`)
surveyRaw$`rushes`<-as.factor(surveyRaw$`rushes`)
surveyRaw$`rice`<-as.factor(surveyRaw$`rice`)
surveyRaw$waterhyacinth<-as.factor(surveyRaw$waterhyacinth)
surveyRaw$palmfronds<-as.factor(surveyRaw$palmfronds)
surveyRaw$sedge<-as.factor(surveyRaw$sedge)
surveyRaw$grass<-as.factor(surveyRaw$grass)
surveyRaw$banana<-as.factor(surveyRaw$banana)
surveyRaw$veg_any<-as.factor(surveyRaw$veg_any)
surveyRaw$mud<-as.factor(surveyRaw$mud)
surveyRaw$sand<-as.factor(surveyRaw$sand)
surveyRaw$rock<-as.factor(surveyRaw$rock)
surveyRaw$concrete<-as.factor(surveyRaw$concrete)
surveyRaw$roots<-as.factor(surveyRaw$roots)
surveyRaw$Litter<-as.factor(surveyRaw$Litter)
surveyRaw$`Dead.wood`<-as.factor(surveyRaw$`Dead.wood`)
surveyRaw$wudu<-as.factor(surveyRaw$wudu)
surveyRaw$bathing<-as.factor(surveyRaw$bathing)
surveyRaw$clothes<-as.factor(surveyRaw$clothes)
surveyRaw$dishes<-as.factor(surveyRaw$dishes)
surveyRaw$carbike<-as.factor(surveyRaw$carbike)
surveyRaw$collectingwater<-as.factor(surveyRaw$collectingwater)
surveyRaw$swimmingplaying<-as.factor(surveyRaw$swimmingplaying)
surveyRaw$fishing<-as.factor(surveyRaw$fishing)
surveyRaw$Ricecult<-as.factor(surveyRaw$Ricecult)
surveyRaw$otherfarming<-as.factor(surveyRaw$otherfarming)
surveyRaw$sanitation<-as.factor(surveyRaw$sanitation)
surveyRaw$water_contact<-as.factor(surveyRaw$water_contact)
surveyRaw$cow<-as.factor(surveyRaw$cow)
surveyRaw$goat<-as.factor(surveyRaw$goat)
surveyRaw$donkey<-as.factor(surveyRaw$donkey)
surveyRaw$ungulate<-as.factor(surveyRaw$ungulate)




#############################################################################
###### Shehia-level data set - infection rates among school children ########
#############################################################################

# Load data set
shehiaRaw <- read.csv("../Data/rawData/shehia_school_raw.csv")

## Assign variables appropriate classes
shehiaRaw$`shehia`<-as.factor(shehiaRaw$`shehia`)
shehiaRaw$`type`<-as.factor(shehiaRaw$`type`)
shehiaRaw$`zest_arm`<-as.factor(shehiaRaw$`zest_arm`)

```


### Tidy raw data
Now we merge the data sets to get one data set where each individual *Bulinus* individual (snailRaw) also has information on environmental variables from where it was collected (surveyRaw) and infection rates among school children in the Shehia from where it was collected (shehiaRaw). Finally, we tidy the resulting data set. 
```{r MergeTidy-data, cache=TRUE, warning=FALSE, message=FALSE}


### Merge snailRaw and surveyRaw based on "survey_site" and keep all observations in snailRaw
snailDFtemp1 <- merge(snailRaw, surveyRaw, by.x="survey_site", by.y="survey_site", all.x=TRUE)

# Double check we haven't lost/duplicated any observations
nrow(snailRaw) == nrow(snailDFtemp1) 



### Merge snailDFtemp1 and shehiaRaw based on shehia and keep all observations in snailRaw/snailDFtemp1
snailDFtemp2 <-merge(snailDFtemp1, shehiaRaw, by.x="shehia.x", by.y="shehia", all.x=TRUE)

# Double check we haven't lost/duplicated any observations
nrow(snailRaw) == nrow(snailDFtemp2) 





### Subset columns of interest and create a new data frame with only these columns
snailDF <- snailDFtemp2[c("shehia.x", "survey_site", "snail_id", 
                        "site.x", "survey.x", "type.x",
                        "survey_shehia.x", "wbtype.x", 
                        "wbtype2.x", "lat_Cor", "lon_Cor",
                        "Sh_all", "wlevel", "BgBn_number", "temp", 
                        "ph", "cond", "tds", "sal", "flow", 
                        "depth", "Bfor_pres", "other_snail", 
                        "swimmingplaying", "bathing", 
                        "clothes", "dishes", "collectingwater",
                        "Ricecult", "otherfarming")]





### Rename certain variables for convenience
require(dplyr)
snailDF <- snailDF %>% 
  rename(
    shehia = shehia.x, 
    site = site.x, 
    survey = survey.x, 
    type = type.x, 
    survey_shehia = survey_shehia.x, 
    wbtype = wbtype.x,
    wbtype2 = wbtype2.x
    )


# As we will use "site" nested in "shehia" as random variables, we will remove any sites with six or fewer snails. See the number of snails in each site commented next to the site name below
temp <- nrow(snailDF)
snailDF <- filter(snailDF, site != "Mat7") # 3
snailDF <- filter(snailDF, site != "Mat12") # 3
snailDF <- filter(snailDF, site != "Wam7") # 3
snailDF <- filter(snailDF, site != "Ole13") # 6
snailDF <- filter(snailDF, site != "Waw5") # 5
snailDF <- filter(snailDF, site != "Uku10") # 6

# How many observations were removed?
temp - nrow(snailDF)


# Look at the structure and assign appropriate classes to all variables
str(snailDF)


### Create ordered variables for ordered factor variables
snailDF$type <- factor(snailDF$type, ordered = TRUE, 
                                levels = c("HNR", "HD", "LNR", "LD"))
snailDF$wbtype <- factor(snailDF$wbtype, ordered = TRUE, 
                                levels = c("1", "2", "3", "4", "5", "6", "7"))
snailDF$wlevel <- factor(snailDF$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
snailDF$flow <- factor(snailDF$flow, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
snailDF$depth <- factor(snailDF$depth, ordered = TRUE, 
                                levels = c("1", "2", "3"))



### Change binary variables to integers
snailDF$Bfor_pres <- as.integer(as.character(snailDF$Bfor_pres))
snailDF$other_snail <- as.integer(as.character(snailDF$other_snail))
snailDF$swimmingplaying <- as.integer(as.character(snailDF$swimmingplaying))
snailDF$bathing <- as.integer(as.character(snailDF$bathing))
snailDF$clothes <- as.integer(as.character(snailDF$clothes))
snailDF$dishes <- as.integer(as.character(snailDF$dishes))
snailDF$collectingwater <- as.integer(as.character(snailDF$collectingwater))
snailDF$Ricecult <- as.integer(as.character(snailDF$Ricecult))
snailDF$otherfarming <- as.integer(as.character(snailDF$otherfarming))


### Also create a data frame where all observations have data for all above variables
snailDF.na <- na.omit(snailDF)

# How many observations were removed?
nrow(snailDF) - nrow(snailDF.na)

# Drop levels from both tidied data sets
snailDF <- droplevels(snailDF)
snailDF.na <- droplevels(snailDF.na)
```



### Inspect response variable
The response variable used in these analyses is "Sh_all", which denotes whether each snail was infected (1) or (0). 

As we will be preforming our model selection using the snailDF.na data set, we inspect its variables. 
```{r respvar, cache=TRUE, message=FALSE}
require(ggplot2)
require(dplyr)

### How many are infected (1) and not (0)? 
snailDF.na %>% 
  mutate(y = Sh_all %>% as.character()) %>% 
  ggplot(aes(x = Sh_all)) +
  geom_bar() +
  theme(panel.grid = element_blank())


table(snailDF.na$Sh_all)
```

96%, i.e. the majority, of tested individuals were not infected (3963), whilst 4% were (153). 


### Test for collinearity between explanatory variables
\n
\n
#### USE THIS METHOD (Added **December 2020**)
* https://stats.stackexchange.com/questions/45444/how-do-you-visualize-binary-outcomes-versus-a-continuous-predictor (Added **December 2020**)   


\n
\n

#### Explanatory variables of potential interest
**TOM** can you modify these explanations so that they are correct please? 
* **wlevel** -> water level (ordered categorical expressed as numeric 1:4, where 1 denotes flooded, 2 = normal, 3 = low, 4= dry)    
* **wbtype2** -> waterbody type: either permanent (1) or temporary (0)    
* **syrvey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2    
* **temp** -> water temperature (*C)   
* **cond** -> conductivity; indirect measure of water chemistry   
* **ph** -> potentially correlated with conductivity   
* **type** -> human response to treatment per shehia; whether people got reinfected quickly or not; four categories    
* **tds** -> total dissolved substances; likely correlated with cond and/or sal    
* **sal** -> water salinity; likely correlated with tds, pH and/or sal   
* **flow** -> water flow in four categories   
* **depth** -> water depth in three categories; likely correlated with wbtype2   
* **Swimmingplaying** -> water contract will increase likelihood of snail infection - also this is children swimming and playing and these are the higher risk group for infections based on the disease endemicity (INFORMATIVE PRIOR)   
* **bathing** -> water contract will increase likelihood of snail infection, however people may also be less likely to urinate in these areas because people bathing in them? I would suggest we go with INFORMATIVE that it will increase snail infection now though since there is water contact happening and this is key   
* **othersnail** -> uninformative - presence of other snails may cause 'miracidial sponges' (when schistosomes infect the wrong snail species), however just theory based so we shouldn't use as a prior, but the outcome of model will be interesting.   



**IF POSSIBLE** 
#### Note: these variables will not be included in model fitting
\n
\n
* **Bfor_pres** -> This will be duplicated in the 'othersnail' column since that is a summary stat of any other snail species present, but this species presence may be of particular interest out of the other snail species... This is another closely related Bulinus species Bulinus forskalii that does not transmit schistosomes on Pemba (although does in West Africa) - however its presence in Pemba might confuse the schistosomes if release similar attractants to the other Bulinus species making the miracidia attempt to infect them. This a very loose theory but could be interesting! :)    
* **clothes** -> uninformative    
* **dishes** -> uninformative    
* **collectingwater** -> uninformative   
* **ricecult** -> uninformative   
* **otherfarming** -> uninformative   




Potential collinearity between quantitative explanatory variables is tested using the Kendall rank coefficient to establish whether variables are statistically dependent. This test is non-parametric, i.e. does not rely on any assumptions on the distributions of the variables. Collinearity between qualitative and quantitative explanatory variables is visually examined using box plots. 
```{r collinearity-explanVars-test, message=FALSE, warning=FALSE, cache=TRUE}
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")


### Quantitative explanatory variables: Kendall rank coefficient
chart.Correlation(snailDF.na[,c("temp", "ph", "cond", "tds", "sal")], 
                  histogram=TRUE, pch=19, method = "kendall")
# Each significance level is associated to a symbol : p-values(0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)


### Qualitative and quantitative explanatory variables

## Qualitative variables and temp
ggarrange(ggplot(snailDF.na, aes(x = type, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wbtype2, y = temp)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = survey, y = temp)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wlevel, y = temp)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = flow, y = temp)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = depth, y = temp)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)

## Qualitative variables and pH
ggarrange(ggplot(snailDF.na, aes(x = type, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wbtype2, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = survey, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wlevel, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = flow, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = depth, y = ph)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)

## Qualitative variables and cond
ggarrange(ggplot(snailDF.na, aes(x = type, y = ph)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wbtype2, y = cond)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = survey, y = cond)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = wlevel, y = cond)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = flow, y = cond)) + geom_boxplot(),
          ggplot(snailDF.na, aes(x = depth, y = cond)) + geom_boxplot() + rremove("x.text"), 
          labels = c("type", "wbtype2", "survey", "wlevel", "flow", "depth"),
          ncol = 3, nrow = 2)

```


\n
\n
The majority of explanatory quantitative variables are correlated (p<0.001), and therefore not independent. As such, by the end of the model selection process we want a model that **ONLY includes one quantitative variable**, as including two or more independent variables does not meet model assumptions. Temperature is negatively correlated with pH (p<0.001) and positively correlated with all other variables (p<0.001). All correlation coefficients except between conductivity, total dissolved substances and salinity are less than 0.3, whist conductivity, total dissolved substances and salinity show correlation coefficients close to 1. Only conductivity will be considered from hereon as this variable was measured most precisely. 

\n
\n
\n
Among the qualitative and quantitative explanatory variables, only temperature and depth appear correlated.


# Model fitting and selection

## Viariables
The variables used in initial model selection are as follows: 

### Response variable 
* **Sh_all** -> , which denotes whether each snail was infected (1) or (0). 


### Explanatory variables of potential interest
**TOM** can you modify these explanations so that they are correct please? 
* **wlevel** -> water level    
* **wbtype2** -> waterbody type: either permanent or temporary    
* **survey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2    
* **temp** -> water temperature   
* **cond** -> conductivity; indirect measure of water chemistry   
* **ph** -> potentially correlated with conductivity   
* **type** -> human response to treatment; whether people got reinfected quickly or not; four categories    
* **flow** -> water flow; four categories   
* **depth** -> water depth; three categories; likely correlated with wbtype2   
* **Swimmingplaying** -> water contract will increase likelihood of snail infection - also this is children swimming and playing and these are the higher risk group for infections based on the disease endemicity (INFORMATIVE PRIOR)   
* **bathing** -> water contract will increase likelihood of snail infection, however people may also be less likely to urinate in these areas because people bathing in them? I would suggest we go with INFORMATIVE that it will increase snail infection now though since there is water contact happening and this is key   
* **othersnail** -> uninformative - presence of other snails may cause 'miracidial sponges' (when schistosomes infect the wrong snail species), however just theory based so we shouldn't use as a prior, but the outcome of model will be interesting.   



**IF POSSIBLE** 
\n
\n
* **Bfor_pres** -> This will be duplicated in the 'othersnail' column since that is a summary stat of any other snail species present, but this species presence may be of particular interest out of the other snail species... This is another closely related Bulinus species Bulinus forskalii that does not transmit schistosomes on Pemba (although does in West Africa) - however its presence in Pemba might confuse the schistosomes if release similar attractants to the other Bulinus species making the miracidia attempt to infect them. This a very loose theory but could be interesting! :)    
* **clothes** -> uninformative    
* **dishes** -> uninformative    
* **collectingwater** -> uninformative   
* **ricecult** -> uninformative   
* **otherfarming** -> uninformative   


### Random factors   
* **shehia** -> regions/wards on Pemba
* **site** -> sites within shesias; hence, site is nested within shehia in models


Given the variables described above, we must use a type of generalized linear mixed effects model to test what effects **Sh_all**, i.e. whether snails are infected or not. 





### Distribution
As our data is binary (1 is an individual snail is infected and 0 if not), the choice of distribution (family) is straight forward: we will use a binomial distribution. The link function we will use will depend on the flexibility of model implementation (see below). We will initially try the logit link function; however, given that the logit link function may be inappropriate when the numbers of zeroes and ones are very unequal (as our data is), if possible, we will also try the clog-log and clog-clog links. 


## Model implementation - selection
Given the inherently "low information content" of binary data, we will fit our binomial generalised linear mixed effects model using Bayesian inferences. We will use the R package "brms", which implements Bayesian generalized linear mixed models using the probabilistic programming language Stan. Please see the [brms github page](https://github.com/paul-buerkner/brms) for software installation guides (available for multiple operation systems). Moreover, "brms" allows model fit to be assessed and compared with the Watanabe-Akaike-Information Criterion (WAIC) and leave-one-out cross-validation (LOO).


### Prior specifications
We apply prior distributions to all explanatory variables of potential interest that reflect our actual beliefs and understandings. Our explanatory variables and prior specifications are as follows:
* **wlevel** -> water level    
* **wbtype2** -> waterbody type: either permanent or temporary    
* **syrvey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2; this variable will not be dropped in any model simplification as it accounts for known differences in between different seasons.  
* **temp** -> water temperature in degrees Celsius per survey within the range 22.33C to 33.81C. Although multiple authors have shown that the interplay between the snail:parasite is limited by temperature (mechanism not confirmed), we know/do not know whether it is within the temperature ranges tested here. As such we chose a prior distribution that reflects our this knowledge/lack thereof: a normal prior with mean 0/1/2/3/4 and standard deviation 10. **UPDATE MARCH 2022**: we will use an uninformative prior because its hypothesis-based and existing research is on another species: a normal prior with mean 0 and standard deviation 10. 
* **cond** -> conductivity, which is an indirect measure of water chemistry   
* **ph** ->  
* **type** -> human response to treatment (i.e. the degree to which infected individuals became reinfected) per shehia, which is divided into four categories. We expect responses to treatment to be an indirect measure of human behavior , such that individuals inhabiting shesias with low rates of reinfection are more likely to exhibit less "risky" behaviors compared to those inhabiting Shesias with high rates of reinfection. **UPDATE MARCH 2022**: we will use an uninformative prior because its hypothesis-driven: a normal prior with mean 0 and standard deviation 10. Hence, we use a       

(set_prior("normal(0,10)", class = "b"

"Families binomial, bernoulli, Beta, zero_inflated_binomial, zero_inflated_beta, and zero_one_inflated_beta support logit, probit, probit_approx, cloglog, cauchit, and identity."


##### Useful links
* https://mran.microsoft.com/snapshot/2016-02-05/web/packages/brms/vignettes/brms.pdf   
* https://bookdown.org/ajkurz/DBDA_recoded/jags-brms.html    
* https://www.rensvandeschoot.com/tutorials/brms-started/   
* https://www.rensvandeschoot.com/tutorials/brms-priors/   
* https://www.rensvandeschoot.com/brms-wambs/   
* https://mran.microsoft.com/snapshot/2016-02-05/web/packages/brms/vignettes/brms.pdf (Added **December 2020**)   
* https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2656.13087 (Added **December 2020**)   
* https://cran.r-project.org/web/packages/brms/brms.pdf (Added **December 2020**)   
* https://bayesat.github.io/lund2018/slides/andrey_anikin_slides.pdf (Added **December 2020**)   
* https://www.rensvandeschoot.com/tutorials/generalised-linear-models-with-brms/ (Added **December 2020**)   





### Bayesian Binary logistic Regression (with Non-Informative Priors)

First, we run a model with uninformative priors fitted to all parameters. Each random effect of each grouping factor has a standard deviation parameter, which is restricted to be non-negative and, by default, has a half Cauchy prior with a scale parameter that scales with the standard deviation of the response variable. 

```{r Sh_all-UNINF-fit, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE, echo=FALSE}
require("brms")

### Fit a maximal model with uninformative priors 
max.noInfo <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), # specify bernoulli (not binomial) for a binary logistic regression
      formula = Sh_all ~ # Response variable
        wbtype2 + wlevel + type + survey + flow + depth +
            temp + cond + ph + 
              swimmingplaying + bathing + other_snail +
              Bfor_pres + clothes + dishes + collectingwater +
              Ricecult + otherfarming +
            (1|shehia/site), # Random factor
      warmup = 5000, # burn-in period (i.e. iterations to be discarded)
      iter = 15000, # total number of iterations (including burn-in)
      chains = 3, # number of MCMC 
      inits  = 0, # inits specifies the starting values of the iterations (normally you can either use the maximum likelihood estimates of the parameters as starting values, or simply ask the algorithm to start with zeros)
      seed = 666) # specifies the random seed, allowing for replication of results

# Save object
#saveRDS(max.noInfo, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.rds")
```







```{r Sh_all-UNINF-eval, message=FALSE, warning=FALSE, cache=TRUE, echo=FALSE}
require("brms")

# Read the maximal model file with no informative priors
max.noInfo <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max.noInfo.rds")

# Quick look at the summary
summary(max.noInfo)

# Plot the effect
plot(max.noInfo)
```

Interestingly, the model does not seem to struggle to converge despite the large number of explanatory variables  as evident from Rhat values of 1 and "furry caterpillars" but 95% credible intervals overlap zero for nearly all variables, indicating that we could certainly get rid of some variables. We do this using leave-one-out cross-validation (LOOCV) but first we must refit the maximal model dropping each explanatory variable in turn. The five variables that do not, or only marginally, overlap zero (wlevel, depth, temperature, ph and Bfor_pres) will not be dropped initially.  




```{r Sh_all-UNINF-drop1, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE, echo=FALSE}
require("brms")
### Drop wbtype2
max.noInfo.wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), # specify bernoulli (not binomial) for a binary logistic regression
      formula = Sh_all ~ # Response variable
        wlevel + type + survey + flow + depth +
            temp + cond + ph + 
              swimmingplaying + bathing + other_snail +
              Bfor_pres + clothes + dishes + collectingwater +
              Ricecult + otherfarming +
            (1|shehia/site), # Random factor
      warmup = 5000, # burn-in period (i.e. iterations to be discarded)
      iter = 15000, # total number of iterations (including burn-in)
      chains = 3, # number of MCMC 
      inits  = 0, # inits specifies the starting values of the iterations (normally you can either use the maximum likelihood estimates of the parameters as starting values, or simply ask the algorithm to start with zeros)
      seed = 666) # specifies the random seed, allowing for replication of results
# Save object
saveRDS(max.noInfo.wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.wbtype2.rds")

### Drop wlevel
max.noInfo.wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wbtype2 + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max.noInfo.wlevel, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.wlevel.rds")

### Drop type
max.noInfo.type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max.noInfo.type, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.type.rds")

### Drop flow
max.noInfo.flow <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max.noInfo.flow, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.flow.rds")

### Drop depth
max.noInfo.depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + temp + cond + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.depth, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.depth.rds")

### Drop temp
max.noInfo.temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + cond + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.temp, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.temp.rds")

### Drop cond
max.noInfo.cond <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + ph + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.cond, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.cond.rds")

### Drop ph
max.noInfo.ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + 
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.ph, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.ph.rds")

### Drop swimmingplaying
max.noInfo.swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.swimmingplaying.rds")

### Drop bathing
max.noInfo.bathing <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.bathing, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.bathing.rds")

### Drop other_snail
max.noInfo.other_snail <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.other_snail, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.other_snail.rds")

### Drop Bfor_pres
max.noInfo.Bfor_pres <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~ 
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + 
        clothes + dishes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.Bfor_pres, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.Bfor_pres.rds")

### Drop clothes (LOL)
max.noInfo.clothes <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        dishes + collectingwater + Ricecult + otherfarming +
# Save object
saveRDS(max.noInfo.clothes, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.clothes.rds")

### Drop dishes
max.noInfo.dishes <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + collectingwater + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.dishes, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.dishes.rds")
####################################################################

### Drop collectingwater
max.noInfo.dishes <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + Ricecult + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.collectingwater, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.collectingwater.rds")


### Drop Ricecult
max.noInfo.ricecult <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + otherfarming +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.ricecult, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.ricecult.rds")


### Drop otherfarming
max.noInfo.otherfarming <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), 
      formula = Sh_all ~
        wlevel + wbtype2 + survey + type + flow + depth + temp + cond + ph +
        swimmingplaying + bathing + other_snail + Bfor_pres + 
        clothes + dishes + collectingwater + Ricecult +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666)
# Save object
saveRDS(max.noInfo.otherfarming, "../Data/ModelOutputs/InfectionPrevalence/max.noInfo.otherfarming.rds")
```

\n
\n











## Maximal-minimal 1st iteration

### Fit maximal model
```{r Sh_all-drop1-max-fit, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Maximal
max1st <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit), # specify bernoulli (not binomial) for a binary logistic regression
      formula = Sh_all ~ # Response variable
        wbtype2 + wlevel + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), # Random factor
      warmup = 5000, # burn-in period (i.e. iterations to be discarded)
      iter = 15000, # total number of iterations (including burn-in)
      chains = 3, # number of MCMC 
      inits  = 0, # inits specifies the starting values of the iterations (normally you can either use the maximum likelihood estimates of the parameters as starting values, or simply ask the algorithm to start with zeros)
      seed = 666) # specifies the random seed, allowing for replication of results

# Save object
#saveRDS(max1st, "../Data/ModelOutputs/InfectionPrevalence/max1st.rds")
```

### Inspect maximal model
```{r Sh_all-drop1-max, message=FALSE, warning=FALSE, cache=TRUE, eval=TRUE}
require("brms")
# Read model output
max1st <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st.rds")

# Quick look at the summary
summary(max1st)

# Plot the effect
plot(max1st)
```
Interestingly, the model does not seem to struggle to converge despite the large number of explanatory variables  as evident from Rhat values of 1 and "furry caterpillars" but 95% credible intervals overlap zero for nearly all variables, indicating that we could certainly get rid of some variables. We do this using lPareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO-CV) but first we must refit the maximal model dropping each explanatory variable in turn. The five variables that do not, or only marginally, overlap zero (wlevel, depth, temperature, ph and Bfor_pres) will not be dropped initially.  

### Fit leave-one-out models
```{r Sh_all-drop1, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max1st_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_wbtype2.rds")

### Drop wlevel
max1st_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_wlevel.rds")

### Drop type
max1st_drop_type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_type, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_type.rds")

### Drop flow
max1st_drop_flow <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_flow, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_flow.rds")

### Drop depth
max1st_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_depth.rds")

### Drop temp
max1st_drop_temp <- 
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_temp.rds")

### Drop cond
max1st_drop_cond <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + temp + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_cond, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_cond.rds")

### Drop ph
max1st_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + temp + cond + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_ph.rds")

### Drop swimmingplaying
max1st_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + temp + cond + ph + 
        bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_swimmingplaying.rds")

### Drop bathing
max1st_drop_bathing <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_bathing, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_bathing.rds")

### Drop other_snail
max1st_drop_other_snail <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + flow + depth + temp + cond + ph + 
        swimmingplaying + bathing +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max1st_drop_other_snail, "../Data/ModelOutputs/InfectionPrevalence/max1st_drop_other_snail.rds")
```




### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 


We use the loo package to carry out Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) for purposes of model checking and model comparison.   
- Reference: https://link.springer.com/article/10.1007/s11222-016-9696-4  
- Useful link: https://mc-stan.org/loo/articles/loo2-example.html   
We compare three models at a time for html markdown to knit because the process is computationally expensive and the Pareto smoothed importance-sampling objects are approx 1GB per model.




```{r PSISLOO-1st, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max1st_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_wbtype2.rds")
max1st_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_wlevel.rds")
max1st_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_type.rds")
max1st_drop_flow <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_flow.rds")
max1st_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_depth.rds")
max1st_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_temp.rds")
max1st_drop_cond <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_cond.rds")
max1st_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_ph.rds")
max1st_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_swimmingplaying.rds")
max1st_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_bathing.rds")
max1st_drop_other_snail <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_other_snail.rds")

# compute PSIS-LOO values with the loo function
#loo_max.noInfo.flow <- loo(max.noInfo.flow, save_psis = TRUE)
loo_max1st_drop_wbtype2 <- loo(max1st_drop_wbtype2, save_psis = TRUE)
loo_max1st_drop_wlevel <- loo(max1st_drop_wlevel, save_psis = TRUE)
loo_max1st_drop_type <- loo(max1st_drop_type, save_psis = TRUE)
loo_max1st_drop_flow <- loo(max1st_drop_flow, save_psis = TRUE)
loo_max1st_drop_depth <- loo(max1st_drop_depth, save_psis = TRUE)
loo_max1st_drop_temp <- loo(max1st_drop_temp, save_psis = TRUE)
loo_max1st_drop_cond <- loo(max1st_drop_cond, save_psis = TRUE)
loo_max1st_drop_ph <- loo(max1st_drop_ph, save_psis = TRUE)
loo_max1st_drop_swimmingplaying <- loo(max1st_drop_swimmingplaying, save_psis = TRUE)
loo_max1st_drop_bathing <- loo(max1st_drop_bathing, save_psis = TRUE)
loo_max1st_drop_other_snail <- loo(max1st_drop_other_snail, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max1st_drop_wbtype2, loo_max1st_drop_wlevel, 
            loo_max1st_drop_type, loo_max1st_drop_flow,
            loo_max1st_drop_depth,  loo_max1st_drop_temp,
            loo_max1st_drop_cond, loo_max1st_drop_ph,
            loo_max1st_drop_swimmingplaying, loo_max1st_drop_bathing,
            loo_max1st_drop_other_snail)
```
                            elpd_diff se_diff
max1st_drop_flow             0.0       0.0   
max1st_drop_other_snail     -2.4       1.2   
max1st_drop_cond            -2.7       1.3   
max1st_drop_bathing         -3.1       0.7   
max1st_drop_type            -3.2       1.1   
max1st_drop_wbtype2         -3.5       1.2   
max1st_drop_ph              -3.6       1.8   
max1st_drop_swimmingplaying -3.9       0.9   
max1st_drop_temp            -5.0       3.3   
max1st_drop_wlevel          -8.6       5.4   
max1st_drop_depth           -9.7       5.3  

## Maximal-minimal 2nd iteration

### Inspect maximal model
Lets have a look before dropping further variables
```{r Sh_all-drop2-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")

max1st_drop_flow <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_flow.rds")

# Quick look at the summary
summary(max1st_drop_flow)

# Plot the effect
plot(max1st_drop_flow)
```


### Fit leave-one-out models
We're dropping flow first and re-running dropping eahc variable in turn
```{r Sh_all-drop2, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max2nd_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_wbtype2.rds")

### Drop wlevel
max2nd_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_wlevel.rds")

### Drop type
max2nd_drop_type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_type, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_type.rds")

### Drop depth
max2nd_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + temp + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_depth.rds")

### Drop temp
max2nd_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + cond + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_temp.rds")

### Drop cond
max2nd_drop_cond <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + ph + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_cond, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_cond.rds")

### Drop ph
max2nd_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + cond + 
        swimmingplaying + bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_ph.rds")

### Drop swimmingplaying
max2nd_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + cond + ph + 
        bathing + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_swimmingplaying.rds")

### Drop bathing
max2nd_drop_bathing <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + cond + ph + 
        swimmingplaying + other_snail +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_bathing, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_bathing.rds")

### Drop other_snail
max2nd_drop_other_snail <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max2nd_drop_other_snail, "../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_other_snail.rds")
```

### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-2nd, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max1st_drop_flow <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max1st_drop_flow.rds")
max2nd_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_wbtype2.rds")
max2nd_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_wlevel.rds")
max2nd_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_type.rds")
max2nd_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_depth.rds")
max2nd_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_temp.rds")
max2nd_drop_cond <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_cond.rds")
max2nd_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_ph.rds")
max2nd_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_swimmingplaying.rds")
max2nd_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_bathing.rds")
max2nd_drop_other_snail <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_other_snail.rds")
# compute PSIS-LOO values with the loo function
loo_max1st_drop_flow <- loo(max1st_drop_flow, save_psis = TRUE)
loo_max2nd_drop_wbtype2 <- loo(max2nd_drop_wbtype2, save_psis = TRUE)
loo_max2nd_drop_wlevel <- loo(max2nd_drop_wlevel, save_psis = TRUE)
loo_max2nd_drop_type <- loo(max2nd_drop_type, save_psis = TRUE)
loo_max2nd_drop_depth <- loo(max2nd_drop_depth, save_psis = TRUE)
loo_max2nd_drop_temp <- loo(max2nd_drop_temp, save_psis = TRUE)
loo_max2nd_drop_cond <- loo(max2nd_drop_cond, save_psis = TRUE)
loo_max2nd_drop_ph <- loo(max2nd_drop_ph, save_psis = TRUE)
loo_max2nd_drop_swimmingplaying <- loo(max2nd_drop_swimmingplaying, save_psis = TRUE)
loo_max2nd_drop_bathing <- loo(max2nd_drop_bathing, save_psis = TRUE)
loo_max2nd_drop_other_snail <- loo(max2nd_drop_other_snail, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max1st_drop_flow, loo_max2nd_drop_wbtype2, 
            loo_max2nd_drop_wlevel, loo_max2nd_drop_type, 
            loo_max2nd_drop_depth,  loo_max2nd_drop_temp,
            loo_max2nd_drop_cond, loo_max2nd_drop_ph,
            loo_max2nd_drop_swimmingplaying, loo_max2nd_drop_bathing,
            loo_max2nd_drop_other_snail)
```
                            elpd_diff se_diff
max2nd_drop_other_snail      0.0       0.0   
max2nd_drop_bathing         -0.5       0.7   
max2nd_drop_type            -0.6       0.9   
max2nd_drop_cond            -1.0       1.5   
max2nd_drop_wbtype2         -1.2       0.9   
max2nd_drop_swimmingplaying -1.2       0.8   
max1st_drop_flow            -1.2       0.9   
max2nd_drop_ph              -1.4       1.9   
max2nd_drop_temp            -5.2       3.6   
max2nd_drop_wlevel          -8.1       5.7   
max2nd_drop_depth           -9.7       5.2  




## Maximal-minimal 3rd iteration

### Inspect maximal model
Lets have a look before dropping further variables
```{r Sh_all-drop3-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")

max2nd_drop_other_snail <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_other_snail.rds")

# Quick look at the summary
summary(max2nd_drop_other_snail)

# Plot the effect
plot(max2nd_drop_other_snail)
```





### Fit leave-one-out models
We're dropping flow first and re-running dropping eahc variable in turn
```{r Sh_all-drop3, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max3rd_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_wbtype2.rds")

### Drop wlevel
max3rd_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + type + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_wlevel.rds")

### Drop type
max3rd_drop_type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_type, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_type.rds")

### Drop depth
max3rd_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + temp + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_depth.rds")

### Drop temp
max3rd_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + cond + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_temp.rds")

### Drop cond
max3rd_drop_cond <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_cond, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_cond.rds")

### Drop ph
max3rd_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + cond + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_ph.rds")

### Drop swimmingplaying
max3rd_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + cond + ph +
        bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_swimmingplaying.rds")

### Drop bathing
max3rd_drop_bathing <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + cond + ph +
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max3rd_drop_bathing, "../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_bathing.rds")
```


### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-3rd, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max2nd_drop_other_snail <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max2nd_drop_other_snail.rds")
max3rd_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_wbtype2.rds")
max3rd_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_wlevel.rds")
max3rd_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_type.rds")
max3rd_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_depth.rds")
max3rd_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_temp.rds")
max3rd_drop_cond <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_cond.rds")
max3rd_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_ph.rds")
max3rd_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_swimmingplaying.rds")
max3rd_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_bathing.rds")
# compute PSIS-LOO values with the loo function
loo_max2nd_drop_other_snail <- loo(max2nd_drop_other_snail, save_psis = TRUE)
loo_max3rd_drop_wbtype2 <- loo(max3rd_drop_wbtype2, save_psis = TRUE)
loo_max3rd_drop_wlevel <- loo(max3rd_drop_wlevel, save_psis = TRUE)
loo_max3rd_drop_type <- loo(max3rd_drop_type, save_psis = TRUE)
loo_max3rd_drop_depth <- loo(max3rd_drop_depth, save_psis = TRUE)
loo_max3rd_drop_temp <- loo(max3rd_drop_temp, save_psis = TRUE)
loo_max3rd_drop_cond <- loo(max3rd_drop_cond, save_psis = TRUE)
loo_max3rd_drop_ph <- loo(max3rd_drop_ph, save_psis = TRUE)
loo_max3rd_drop_swimmingplaying <- loo(max3rd_drop_swimmingplaying, save_psis = TRUE)
loo_max3rd_drop_bathing <- loo(max3rd_drop_bathing, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max2nd_drop_other_snail, loo_max3rd_drop_wbtype2, 
            loo_max3rd_drop_wlevel, loo_max3rd_drop_type, 
            loo_max3rd_drop_depth,  loo_max3rd_drop_temp,
            loo_max3rd_drop_cond, loo_max3rd_drop_ph,
            loo_max3rd_drop_swimmingplaying, loo_max3rd_drop_bathing)
```
                            elpd_diff se_diff
max3rd_drop_cond              0.0       0.0  
max3rd_drop_bathing          -0.4       0.9  
max3rd_drop_type             -0.6       1.0  
max2nd_drop_other_snail      -1.2       0.9  
max3rd_drop_wbtype2          -1.3       1.2  
max3rd_drop_swimmingplaying  -1.4       1.0  
max3rd_drop_ph               -1.5       1.9  
max3rd_drop_temp             -5.4       4.1  
max3rd_drop_wlevel           -8.3       5.8  
max3rd_drop_depth           -10.3       5.2 

We're dropping cond


## Maximal-minimal 4th iteration

### Inspect maximal model
Lets have a look before dropping further variables
```{r Sh_all-drop4-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")

max3rd_drop_cond <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_cond.rds")

# Quick look at the summary
summary(max3rd_drop_cond)

# Plot the effect
plot(max3rd_drop_cond)
```



### Fit leave-one-out models
```{r Sh_all-drop4, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max4th_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + type + depth + temp + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_wbtype2.rds")

### Drop wlevel
max4th_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + type + survey + depth + temp + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_wlevel.rds")

### Drop type
max4th_drop_type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_type, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_type.rds")

### Drop depth
max4th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + temp + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_depth.rds")

### Drop temp
max4th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + ph + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_temp.rds")

### Drop ph
max4th_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + 
        swimmingplaying + bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_ph.rds")

### Drop swimmingplaying
max4th_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + ph +
        bathing + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_swimmingplaying.rds")

### Drop bathing
max4th_drop_bathing <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + ph +
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max4th_drop_bathing, "../Data/ModelOutputs/InfectionPrevalence/max4th_drop_bathing.rds")
```



### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-4th, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max3rd_drop_cond <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max3rd_drop_cond.rds")
max4th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_wbtype2.rds")
max4th_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_wlevel.rds")
max4th_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_type.rds")
max4th_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_depth.rds")
max4th_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_temp.rds")
max4th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_ph.rds")
max4th_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_swimmingplaying.rds")
max4th_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_bathing.rds")
# compute PSIS-LOO values with the loo function
loo_max3rd_drop_cond <- loo(max3rd_drop_cond, save_psis = TRUE)
loo_max4th_drop_wbtype2 <- loo(max4th_drop_wbtype2, save_psis = TRUE)
loo_max4th_drop_wlevel <- loo(max4th_drop_wlevel, save_psis = TRUE)
loo_max4th_drop_type <- loo(max4th_drop_type, save_psis = TRUE)
loo_max4th_drop_depth <- loo(max4th_drop_depth, save_psis = TRUE)
loo_max4th_drop_temp <- loo(max4th_drop_temp, save_psis = TRUE)
loo_max4th_drop_ph <- loo(max4th_drop_ph, save_psis = TRUE)
loo_max4th_drop_swimmingplaying <- loo(max4th_drop_swimmingplaying, save_psis = TRUE)
loo_max4th_drop_bathing <- loo(max4th_drop_bathing, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max3rd_drop_cond, loo_max4th_drop_wbtype2, 
            loo_max4th_drop_wlevel, loo_max4th_drop_type, 
            loo_max4th_drop_depth,  loo_max4th_drop_temp,
            loo_max4th_drop_ph, loo_max4th_drop_swimmingplaying, 
            loo_max4th_drop_bathing)
```
                            elpd_diff se_diff
max4th_drop_bathing          0.0       0.0   
max4th_drop_type            -0.2       0.7   
max3rd_drop_cond            -0.5       0.7   
max4th_drop_wbtype2         -0.6       1.0   
max4th_drop_swimmingplaying -1.1       1.1   
max4th_drop_ph              -1.4       2.1   
max4th_drop_temp            -6.6       3.9   
max4th_drop_wlevel          -7.8       5.5   
max4th_drop_depth           -9.7       5.2  

We're dropping bathing

## Maximal-minimal 5th iteration

### Inspect maximal model
Lets have a look before dropping further variables

```{r Sh_all-drop5-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")

max4th_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_bathing.rds")

# Quick look at the summary
summary(max4th_drop_bathing)

# Plot the effect
plot(max4th_drop_bathing)
```


### Fit leave-one-out models
```{r Sh_all-drop5, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max5th_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + type + depth + temp + ph + 
        swimmingplaying +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_wbtype2.rds")

### Drop wlevel
max5th_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + type + survey + depth + temp + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_wlevel.rds")

### Drop type
max5th_drop_type <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_type, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_type.rds")

### Drop depth
max5th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + temp + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_depth.rds")

### Drop temp
max5th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_temp.rds")

### Drop ph
max5th_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_ph.rds")

### Drop swimmingplaying
max5th_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + type + depth + temp + ph +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max5th_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max5th_drop_swimmingplaying.rds")
```


### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-5th, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max4th_drop_bathing <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max4th_drop_bathing.rds")
max5th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_wbtype2.rds")
max5th_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_wlevel.rds")
max5th_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_type.rds")
max5th_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_depth.rds")
max5th_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_temp.rds")
max5th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_ph.rds")
max5th_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_swimmingplaying.rds")
# compute PSIS-LOO values with the loo function
loo_max4th_drop_bathing <- loo(max4th_drop_bathing, save_psis = TRUE)
loo_max5th_drop_wbtype2 <- loo(max5th_drop_wbtype2, save_psis = TRUE)
loo_max5th_drop_wlevel <- loo(max5th_drop_wlevel, save_psis = TRUE)
loo_max5th_drop_type <- loo(max5th_drop_type, save_psis = TRUE)
loo_max5th_drop_depth <- loo(max5th_drop_depth, save_psis = TRUE)
loo_max5th_drop_temp <- loo(max5th_drop_temp, save_psis = TRUE)
loo_max5th_drop_ph <- loo(max5th_drop_ph, save_psis = TRUE)
loo_max5th_drop_swimmingplaying <- loo(max5th_drop_swimmingplaying, save_psis = TRUE)

# Compare PSIS-LOO values
loo_compare(loo_max4th_drop_bathing, loo_max5th_drop_wbtype2, 
            loo_max5th_drop_wlevel, loo_max5th_drop_type, 
            loo_max5th_drop_depth,  loo_max5th_drop_temp,
            loo_max5th_drop_ph, loo_max5th_drop_swimmingplaying)
```
                            elpd_diff se_diff
max5th_drop_type             0.0       0.0   
max4th_drop_bathing         -0.4       0.8   
max5th_drop_swimmingplaying -0.4       0.8   
max5th_drop_wbtype2         -0.5       1.0   
max5th_drop_ph              -1.3       1.9   
max5th_drop_temp            -6.5       3.7   
max5th_drop_wlevel          -8.2       5.3   
max5th_drop_depth           -9.5       5.0 


## Maximal-minimal 6th iteration

### Inspect maximal model
Lets have a look before dropping further variables

```{r Sh_all-drop6-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")

max5th_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_type.rds")

# Quick look at the summary
summary(max5th_drop_type)

# Plot the effect
plot(max5th_drop_type)
```




### Fit leave-one-out models
```{r Sh_all-drop6, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max6th_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + temp + ph + 
        swimmingplaying +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_wbtype2.rds")

### Drop wlevel
max6th_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + survey + depth + temp + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_wlevel.rds")

### Drop depth
max6th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + temp + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_depth.rds")

### Drop temp
max6th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + ph + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_temp.rds")

### Drop ph
max6th_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + 
        swimmingplaying + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_ph.rds")

### Drop swimmingplaying
max6th_drop_swimmingplaying <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + ph +
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max6th_drop_swimmingplaying, "../Data/ModelOutputs/InfectionPrevalence/max6th_drop_swimmingplaying.rds")
```


### Model Comparison: Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-6th, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max5th_drop_type <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max5th_drop_type.rds")
max6th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_wbtype2.rds")
max6th_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_wlevel.rds")
max6th_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_depth.rds")
max6th_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_temp.rds")
max6th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_ph.rds")
max6th_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_swimmingplaying.rds")
# compute PSIS-LOO values with the loo function
loo_max5th_drop_type <- loo(max5th_drop_type, save_psis = TRUE)
loo_max6th_drop_wbtype2 <- loo(max6th_drop_wbtype2, save_psis = TRUE)
loo_max6th_drop_wlevel <- loo(max6th_drop_wlevel, save_psis = TRUE)
loo_max6th_drop_depth <- loo(max6th_drop_depth, save_psis = TRUE)
loo_max6th_drop_temp <- loo(max6th_drop_temp, save_psis = TRUE)
loo_max6th_drop_ph <- loo(max6th_drop_ph, save_psis = TRUE)
loo_max6th_drop_swimmingplaying <- loo(max6th_drop_swimmingplaying, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max5th_drop_type, loo_max6th_drop_wbtype2, 
            loo_max6th_drop_wlevel, loo_max6th_drop_depth,  
            loo_max6th_drop_temp, loo_max6th_drop_ph, 
            loo_max6th_drop_swimmingplaying)
```
                            elpd_diff se_diff
max5th_drop_type             0.0       0.0   
max6th_drop_swimmingplaying  0.0       0.5   
max6th_drop_wbtype2         -0.2       0.4   
max6th_drop_ph              -0.8       1.6   
max6th_drop_temp            -5.8       3.7   
max6th_drop_wlevel          -7.6       5.4   
max6th_drop_depth           -9.2       5.2  




## Maximal-minimal 7th iteration

### Inspect maximal model
Lets have a look before dropping further variables

```{r Sh_all-drop7-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")

max6th_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_swimmingplaying.rds")

# Quick look at the summary
summary(max6th_drop_swimmingplaying)

# Plot the effect
plot(max6th_drop_swimmingplaying)
```


### Fit leave-one-out models
```{r Sh_all-drop7, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wbtype2
max7th_drop_wbtype2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + temp + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max7th_drop_wbtype2, "../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wbtype2.rds")

### Drop wlevel
max7th_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + survey + depth + temp + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max7th_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wlevel.rds")

### Drop depth
max7th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + temp + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max7th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max7th_drop_depth.rds")

### Drop temp
max7th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max7th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max7th_drop_temp.rds")

### Drop ph
max7th_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wbtype2 + wlevel + survey + depth + temp + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max7th_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max7th_drop_ph.rds")
```



### leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-7th, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max6th_drop_swimmingplaying <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max6th_drop_swimmingplaying.rds")
max7th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wbtype2.rds")
max7th_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wlevel.rds")
max7th_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_depth.rds")
max7th_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_temp.rds")
max7th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_ph.rds")
# compute PSIS-LOO values with the loo function
loo_max6th_drop_swimmingplaying <- loo(max6th_drop_swimmingplaying, save_psis = TRUE)
loo_max7th_drop_wbtype2 <- loo(max7th_drop_wbtype2, save_psis = TRUE)
loo_max7th_drop_wlevel <- loo(max7th_drop_wlevel, save_psis = TRUE)
loo_max7th_drop_depth <- loo(max7th_drop_depth, save_psis = TRUE)
loo_max7th_drop_temp <- loo(max7th_drop_temp, save_psis = TRUE)
loo_max7th_drop_ph <- loo(max7th_drop_ph, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max6th_drop_swimmingplaying, loo_max7th_drop_wbtype2, 
            loo_max7th_drop_wlevel, loo_max7th_drop_depth,  
            loo_max7th_drop_temp, loo_max7th_drop_ph)
```
                            elpd_diff se_diff
max7th_drop_wbtype2          0.0       0.0   
max6th_drop_swimmingplaying -0.1       0.4   
max7th_drop_ph              -0.7       1.6   
max7th_drop_temp            -5.9       3.6   
max7th_drop_wlevel          -8.2       5.4   
max7th_drop_depth           -9.2       5.1   


## Maximal-minimal 8th iteration

### Inspect maximal model
Lets have a look before dropping further variables

```{r Sh_all-drop8-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")

max7th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wbtype2.rds")

# Quick look at the summary
summary(max7th_drop_wbtype2)

# Plot the effect
plot(max7th_drop_wbtype2)
```



### Fit leave-one-out models
```{r Sh_all-drop8, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")

### Drop wlevel
max8th_drop_wlevel <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        survey + depth + temp + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max8th_drop_wlevel, "../Data/ModelOutputs/InfectionPrevalence/max8th_drop_wlevel.rds")

### Drop depth
max8th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + temp + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max8th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max8th_drop_depth.rds")

### Drop temp
max8th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + ph + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max8th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max8th_drop_temp.rds")

### Drop ph
max8th_drop_ph <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + temp + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, inits  = 0, seed = 666) 
# Save object
saveRDS(max8th_drop_ph, "../Data/ModelOutputs/InfectionPrevalence/max8th_drop_ph.rds")
```

### leave-one-out cross-validation (PSIS-LOO) 
```{r PSISLOO-8th, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
require("brms")
library("loo")
# Read objects
max7th_drop_wbtype2 <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max7th_drop_wbtype2.rds")
max8th_drop_wlevel <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max8th_drop_wlevel.rds")
max8th_drop_depth <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max8th_drop_depth.rds")
max8th_drop_temp <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max8th_drop_temp.rds")
max8th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max8th_drop_ph.rds")
# compute PSIS-LOO values with the loo function
loo_max7th_drop_wbtype2 <- loo(max7th_drop_wbtype2, save_psis = TRUE)
loo_max8th_drop_wlevel <- loo(max8th_drop_wlevel, save_psis = TRUE)
loo_max8th_drop_depth <- loo(max8th_drop_depth, save_psis = TRUE)
loo_max8th_drop_temp <- loo(max8th_drop_temp, save_psis = TRUE)
loo_max8th_drop_ph <- loo(max8th_drop_ph, save_psis = TRUE)
# Compare PSIS-LOO values
loo_compare(loo_max7th_drop_wbtype2, 
            loo_max8th_drop_wlevel, loo_max8th_drop_depth,  
            loo_max8th_drop_temp, loo_max8th_drop_ph)
```
                    elpd_diff se_diff
max7th_drop_wbtype2  0.0       0.0   
max8th_drop_ph      -0.5       1.5   
max8th_drop_temp    -5.8       3.6   
max8th_drop_wlevel  -8.0       5.4   
max8th_drop_depth   -9.5       5.1  

We're dropping ph, which is good news because temperature is negatively correlated with pH (-0.27, p<0.001) so we should only include one. 


## Maximal-minimal 9th iteration

### Inspect maximal model
Lets have a look before dropping further variables

```{r Sh_all-drop9-max, message=FALSE, warning=FALSE, cache=TRUE}
require("brms")
require("PerformanceAnalytics")
require("ggplot2")
require("ggpubr")

max8th_drop_ph <- readRDS("../Data/ModelOutputs/InfectionPrevalence/max8th_drop_ph.rds")

# Quick look at the summary
summary(max8th_drop_ph)

# Plot the effect
plot(max8th_drop_ph)
```

This model output produces a warning reg. divergent transitions:

1: Warning message:
There were 160 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 

We have some divergent transitions (160 to be precise) and therefore thin by 3 and increase adapt_delta to 0.99 (max is 1; tried 0.95, which gave 8 divergent transitions instead of 160).


```{r Sh_all-drop9-max-v2, message=FALSE, warning=FALSE, eval=FALSE, cache=TRUE}
### Drop ph
max8th_drop_ph_v2 <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + temp + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, 
      thin = 3, 
      inits  = 0, seed = 666,
      control = list(adapt_delta = 0.99)) 
# Save object
saveRDS(max8th_drop_ph_v3, "../Data/ModelOutputs/InfectionPrevalence/max8th_drop_ph_v2.rds")
```
Yay, no divergent transitions! 


### Fit new exploratory models

* **wlevel** -> water level (ordered categorical expressed as numeric 1:4, where 1 denotes flooded, 2 = normal, 3 = low, 4= dry)    
* **syrvey** -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2 **4/4/2022: Ziggy told G season predicts age structure and young snail individuals are more easily infected -> Keep as fixed season effect or random survey effect?**    
* **temp** -> water temperature (*C)   
* **depth** -> water depth in three categories; highly correlated with temp   


*I'm fitting a few new models here cos I dunno what Tom wants/makes ecological sense bu here are the changes I'll make and how I'm thinking:*

* Drop depth as explanatory variable because temperature and depth are highly correlated.   
* Drop temperature as explanatory variable because temperature and depth are highly correlated.  
* Drop depth as explanatory variable *AND* make survey random factor because we are not only interested in these particular surveys?   
* Drop temperature as explanatory variable *AND* make survey random factor because we are not only interested in these particular surveys?   

```{r Sh_all-drop9-max-v4, message=FALSE, eval=FALSE, warning=FALSE, cache=TRUE}
### Drop depth
max9th_drop_depth <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + temp + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, 
      thin = 3, 
      inits  = 0, seed = 666,
      control = list(adapt_delta = 0.9999)) # because 0.99 gave 1 divergent transition after warmup
# Save object
saveRDS(max9th_drop_depth, "../Data/ModelOutputs/InfectionPrevalence/max9th_drop_depth.rds")

### Drop depth & make survey random
max9th_drop_depth_random_survey <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + temp + 
        (1|survey) + (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, 
      thin = 3, 
      inits  = 0, seed = 666,
      control = list(adapt_delta = 0.9999)) # because 0.99 gave 1 divergent transition after warmup
# Save object
saveRDS(max9th_drop_depth_random_survey, "../Data/ModelOutputs/InfectionPrevalence/max9th_drop_depth_random_survey.rds")

### Drop temperature
max9th_drop_temp <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + survey + depth + 
        (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, 
      thin = 3, 
      inits  = 0, seed = 666,
      control = list(adapt_delta = 0.9999))# because 0.99 gave 2 divergent transitions after warmup
# Save object
saveRDS(max9th_drop_temp, "../Data/ModelOutputs/InfectionPrevalence/max9th_drop_temp.rds")


### Drop temperature & make survey random
max9th_drop_temp_random_survey <-
  brm(data = snailDF.na, 
      family = bernoulli(link = logit),
      formula = Sh_all ~ 
        wlevel + depth + 
        (1|survey) + (1|shehia/site), 
      warmup = 5000, iter = 15000, chains = 3, 
      thin = 3, 
      inits  = 0, seed = 666,
      control = list(adapt_delta = 0.9999)) 
# Save object
saveRDS(max9th_drop_temp_random_survey, "../Data/ModelOutputs/InfectionPrevalence/max9th_drop_temp_random_survey.rds")
```





## OLD SCRIPT BELOW - IGNORE

### Final model

```{r glmer1.17, message=FALSE, warning=FALSE, cache=TRUE, eval=FALSE}
library(arm)

df.na.glmer1.17 <- glmer(Sh_all ~ (1|shehia.x/site.x) +
                           wlevel + temp + ph,
                            data = df.na.rem, 
                         family = binomial(link = "logit"),
                         glmerControl("bobyqa"))


AF1 <- allFit(df.na.glmer1.17, verbose=T)
```




#### Overview

Chapter 7.4 of this https://bookdown.org/schmettow/NewStats/GLM.html was brilliant at explaining hot to interpret these outputs!!!!

```{r (df.na.glmer1.17-Overview, cache=TRUE, eval=FALSE}
require(effects)
plot(allEffects(df.na.glmer1.17))
summary(df.na.glmer1.17)
```
\n
\n




#### Water level
**wlevel**: The effect of water level on whether snails are infected or not is statistically significantly positively linear AND negatively quadratic! (since the wlevel.L and wlevel.Q terms are significant). In other words, going from "1" to "2" to "3", the probability of snails being infected increases BUT due to the negative quadratic term, we know that the rate of increase in probability of infection decreases and becomes a negative trend at a certain point. From above plot, its  obvious that "2" has most infections, i.e. infection rate increases from "1" to "2" and decreases from "2" to "3". We can use the "emmeans" to get the estimated probability of snails being infected in each of the water level types and the function automatically back-transforms estimates for us. For instance, the probability of a snail being infected in water level "1" is 0.00132 (+-0.000732)/0.132% of snails are infected.
```{r df.na.glmer1.17-wlevel, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(df.na.glmer1.17, c("wlevel"), data = df.na.rem, type = "response")
```


\n
\n


#### Temperature
**temp**: Temperature has a statistically significant positive effect on whether snails are infected, i.e. with increasing temperatures snails are more likely ti be infected. Averaged over the different water levels, as temperature increases by one degree celsius, the odds of snails being infected increase by a factor of 1.249233 (exp(0.22253))/ increase by 24.9233% (+- 6.3564% (exp(0.22253+0.04963)-exp(0.22253)*100)).

E.g. see below that at 27.5 degrees C, the probability of any given snail being infected is 0.00431; therefore, at 28.5 degrees, the odds of a snail being infected is 0.005384194 (0.00431*1.249233)
\n
```{r df.na.glmer1.17-temp, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(df.na.glmer1.17, c("temp"), data = df.na.rem, type = "response")
exp(0.22253)
```



#### ph
**pH**: ph has a statistically significant negative effect on whether snails are infected, i.e. with increasing ph snails are less likely to be infected. Averaged over the different water levels, as ph increases by one unit, the odds of snails being infected decrease by a factor of 0.4326224 (exp(-0.83789))/ decrease by 56.73776% (1-0.4326224 x 100).

E.g. see below that at ph = 7.01, the probability of asnail being infected is 0.00431; therefore, at ph = 8.01, the odds of a snail being infected is 0.001864603 (0.00431*0.4326224)
\n
```{r df.na.glmer1.17-ph, cache=TRUE, eval=FALSE}
require(emmeans)
emmeans(df.na.glmer1.17, c("ph"), data = df.na.rem, type = "response")
exp(-0.83789)*100
```


\n
\n

### Spatial autocorrelation
\n
\n


```{r spatial-corr-snail-level, cache=TRUE, warning=FALSE, message=FALSE, eval=FALSE}
require(gstat)
require(lme4)
require(sp)

# Snail - gen test
df1 <- read.csv("../Data/TempTom/snail_data_xeno_v1.csv")

# Survey - environmetal variables + human activities
df2 <- read.csv("../Data/TempTom/survey_site_data_xeno_v1.csv")

# Region (Shehia) - schisto prevalence among school childern per region
shehiaRaw <- read.csv("../Data/TempTom/shehia_school_data_v1.csv")

## Set Snail variables as factors
df1$`snail_id`<-as.factor(df1$`snail_id`)
df1$`site`<-as.factor(df1$`site`)
df1$`survey`<-as.factor(df1$`survey`)
df1$`shehia`<-as.factor(df1$`shehia`)
df1$`type`<-as.factor(df1$`type`)
df1$`zest_arm`<-as.factor(df1$`zest_arm`)
df1$`survey_site`<-as.factor(df1$`survey_site`)
df1$`survey_shehia`<-as.factor(df1$`survey_shehia`)
df1$`wbtype`<-as.factor(df1$`wbtype`)
df1$`wbtype2`<-as.factor(df1$`wbtype2`)
df1$`assumed_Bulinus_spp_site`<-as.factor(df1$`assumed_Bulinus_spp_site`)
df1$`ITS-1-2-F_outcome`<-as.factor(df1$`ITS_1_2_F_outcome`)
df1$prepat_schisto_sp<-as.factor(df1$prepat_schisto_sp)
df1$prepat_Sh<-as.factor(df1$prepat_Sh)
df1$prepat_Sb<-as.factor(df1$prepat_Sb)
df1$prepat_ShSb<-as.factor(df1$prepat_ShSb)
df1$prepat_Schisto<-as.factor(df1$prepat_Schisto)
df1$Sh_all<-as.character(df1$Sh_all)
df1$Sh_all<-as.integer(df1$Sh_all)
df1$Sb_all<-as.character(df1$Sb_all)
df1$Sb_all<-as.integer(df1$Sb_all)
df1$'ITSF_2_outcome'<-as.factor(df1$'ITSF_2_outcome')
## have excluded the seq code columns for now could remove ##
df1$'conf_Bulinus_sp'<-as.factor(df1$'conf_Bulinus_sp')
df1$'Bulinus_haplo'<-as.factor(df1$'Bulinus_haplo')
df1$patent_Sh<-as.factor(df1$patent_Sh)
df1$patent_Sb<-as.factor(df1$patent_Sb)
df1$patent_Schisto<-as.factor(df1$patent_Schisto)

# NB can check that variables converted to factor by #
print(is.factor(df1$snail_id))

## Set Site Survey variables as factors
df2$`site`<-as.factor(df2$`USI`)
df2$`survey`<-as.factor(df2$`survey`)
df2$`shehia`<-as.factor(df2$`shehia`)
df2$`type`<-as.factor(df2$`type`)
df2$`zest_arm`<-as.factor(df2$`zest_arm`)
df2$`survey_site`<-as.factor(df2$`survey_site`)
df2$`survey_shehia`<-as.factor(df2$`survey_shehia`)
df2$`wbtype`<-as.factor(df2$`wbtype`)
df2$`wbtype2`<-as.factor(df2$`wbtype2`)
df2$`wlevel`<-as.factor(df2$`wlevel`)
df2$`BgBn_pres`<-as.factor(df2$`BgBn_pres`)
df2$`cerc_sp`<-as.factor(df2$`cerc_sp`)
df2$`flow`<-as.factor(df2$`flow`)
df2$`depth`<-as.factor(df2$`depth`)
df2$`Bfor_pres`<-as.factor(df2$`Bfor_pres`)
df2$`Lym_pres`<-as.factor(df2$`Lym_pres`)
df2$`Mel_pres`<-as.factor(df2$`Mel_pres`)
df2$`Cleo_pres`<-as.factor(df2$`Cleo_pres`)
df2$`Pila_pres`<-as.factor(df2$`Pila_pres`)
df2$`Lan_pres`<-as.factor(df2$`Lan_pres`)
df2$`Thiara_pres`<-as.factor(df2$`Thiara_pres`)
df2$`other_snail`<-as.factor(df2$`other_snail`)
df2$`Lilies`<-as.factor(df2$`Lilies`)
df2$`rushes`<-as.factor(df2$`rushes`)
df2$`rice`<-as.factor(df2$`rice`)
df2$waterhyacinth<-as.factor(df2$waterhyacinth)
df2$palmfronds<-as.factor(df2$palmfronds)
df2$sedge<-as.factor(df2$sedge)
df2$grass<-as.factor(df2$grass)
df2$banana<-as.factor(df2$banana)
df2$veg_any<-as.factor(df2$veg_any)
df2$mud<-as.factor(df2$mud)
df2$sand<-as.factor(df2$sand)
df2$rock<-as.factor(df2$rock)
df2$concrete<-as.factor(df2$concrete)
df2$roots<-as.factor(df2$roots)
df2$Litter<-as.factor(df2$Litter)
df2$`Dead.wood`<-as.factor(df2$`Dead.wood`)
df2$wudu<-as.factor(df2$wudu)
df2$bathing<-as.factor(df2$bathing)
df2$clothes<-as.factor(df2$clothes)
df2$dishes<-as.factor(df2$dishes)
df2$carbike<-as.factor(df2$carbike)
df2$collectingwater<-as.factor(df2$collectingwater)
df2$swimmingplaying<-as.factor(df2$swimmingplaying)
df2$fishing<-as.factor(df2$fishing)
df2$Ricecult<-as.factor(df2$Ricecult)
df2$otherfarming<-as.factor(df2$otherfarming)
df2$sanitation<-as.factor(df2$sanitation)
df2$water_contact<-as.factor(df2$water_contact)
df2$cow<-as.factor(df2$cow)
df2$goat<-as.factor(df2$goat)
df2$donkey<-as.factor(df2$donkey)
df2$ungulate<-as.factor(df2$ungulate)


## Set shehia school as factors
shehiaRaw$`shehia`<-as.factor(shehiaRaw$`shehia`)
shehiaRaw$`type`<-as.factor(shehiaRaw$`type`)
shehiaRaw$`zest_arm`<-as.factor(shehiaRaw$`zest_arm`)


#### Merging datasets for further analysis ####

## merge snail_data with survey_site data ##

# perfrom merge
merge(df1, df2, by.x="survey_site", by.y="survey_site", all.x=TRUE) -> mdf1
# write csv
write.csv(mdf1, "../Data/TempTom/mdf1.csv")

## merge mdf1 data with shehia (schistosomiasis prevalence) data 
# perform merge
merge(mdf1, df3, by.x="shehia.x", by.y="shehia", all.x=TRUE) -> mdf2
write.csv(mdf2, "../Data/TempTom//mdf2.csv")

#### KEEPING COLUMNS of interest FOR FINAL MODEL ####

# created new df with only the columns of interest #

df = mdf2[c("shehia.x", "site.x", "lat_Cor", "lon_Cor", 
            "Sh_all", "wlevel", "temp", "ph")]

# also created a na.omit df, however can specifiy this in the models
df.na <- na.omit(df)

# also created a data set removing the 'low values' sites Mat12 Mat7 Wam7 Ole13 Waw5 Uku10 
library(Hmisc)
library(dplyr)
df.na.rem1 <- filter(df.na, site.x != "Mat7")
df.na.rem2 <- filter(df.na.rem1, site.x != "Mat12")
df.na.rem3 <- filter(df.na.rem2, site.x != "Wam7")
df.na.rem4 <- filter(df.na.rem3, site.x != "Ole13")
df.na.rem5 <- filter(df.na.rem4, site.x != "Waw5")
df.na.rem <- filter(df.na.rem5, site.x != "Uku10")
library(effects)

# creating ordered variables for wlevel (as for other models)
df.na.rem$wlevel <- factor(df.na.rem$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))

# run final model 
library(arm)
library(lme4)
df.na.glmer1.17 <- glmer(Sh_all ~ (1|shehia.x/site.x) +
                           wlevel + temp + ph,
                            data = df.na.rem, 
                         family = binomial(link = "logit"),
                         glmerControl("bobyqa"))

df.na.glmer1.17 <- glmer(Sh_all ~ (1|shehia.x/site.x) +
                           wlevel + temp + ph,
                            data = df.na.rem, 
                         family = binomial(link = "logit"),
                         glmerControl("bobyqa"))


# Find residuals from response variable of final model
E <- residuals(df.na.glmer1.17, type = "response")
#E <- resid(df.na.glmer1.17)

snailDF_res <- data.frame(E, df.na.rem$lat_Cor, df.na.rem$lon_Cor)

coordinates(snailDF_res) <- c("df.na.rem.lat_Cor", "df.na.rem.lon_Cor")

bubble(snailDF_res, "E", col = c("black", "grey"),
       main = "Residuals", xlab = "X-coordinates",
       ylab = "Y-coordinates")

Vario1 <- variogram(E ~ 1, snailDF_res)
plot(Vario1)
```




###!!!! USE Residuals() from BinomTools package (not available for my curr. R version )




