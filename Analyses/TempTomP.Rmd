---
title: "Temp_TomP"
author: "Galina M. JÃ¶nsson"
date: "07/06/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

**Environmental variables of interest**   
- wlevel -> water level   
- wbtype2 -> waterbody typer; either permanent or temporary   
- syrvey -> four surveys; corresponds to time of year; potentially correlated with wlevel and wbtype2   
- temp -> water temperature
- cond -> conductivity; indirect measure of water chemistry
- ph -> potentially correlated with cond
- type -> human "respondence" to treatment; whether ppl got reinfected quickly or not; four categories



# Site-level analyses 

```{r loadNclean-data}
# load data
df2 <- read.csv("../Data/TempTom/df2_new.csv")

# Subset columns of interest
keeps <- c("USI", "shehia", "survey", "type", "wbtype2", "wlevel", "BgBn_pres", "BgBn_number", "temp", "ph", "cond", "Bulinus_xeno", "Sh", "Sh_pres", "Sh_prev")
  
siteDF <- df2[keeps]


siteDF$site <- as.factor(siteDF$USI)
siteDF$survey <- as.factor(siteDF$survey)
siteDF$shehia <- as.factor(siteDF$shehia)
siteDF$type <- factor(siteDF$type, ordered = TRUE, 
                                levels = c("HNR", "HD", "LNR", "LD"))
siteDF$wbtype2 <- as.factor(siteDF$wbtype2)
siteDF$wlevel <- factor(siteDF$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
siteDF$BgBn_pres <- as.factor(siteDF$BgBn_pres)


# remove surveys that were not conducted
siteDF <- siteDF[complete.cases(siteDF[ , "BgBn_number"]),]
```


## Number of Bulinus collected

Lets look at the response variable

```{r respvar, cache=TRUE}
require(ggplot2)
p <- ggplot(siteDF,aes(x=BgBn_number))+
  stat_count(position="identity",alpha=0.5,width = 1)+theme()
p <- p + labs(y = "Density",x = "Number of snails")
p
```



\n

Very zero inflated


##### Generalised linear mixed effects model for number of snails collected per survey - testing distributions

```{r glmer-BgBn_number-families, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
library(arm)

# Poisson
glmm.pos <- glmer(BgBn_number ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) + arm::rescale(cond) +
                 (1|shehia/site), data=siteDF, family = "poisson")

# Negative binomial
glmm.nb <- glmer.nb(BgBn_number ~ wbtype2 + wlevel + type + survey +
                      arm::rescale(temp) + arm::rescale(ph) + arm::rescale(cond) +
                      (1|shehia/site), data=siteDF)

glmm.nb2 <- glmer.nb(BgBn_number ~ wbtype2 + wlevel + type + survey +
                 temp + ph + cond +
                 (1|shehia/site), data=siteDF)

# qq plots 
qqnorm(resid(glmm.pos))
qqline(resid(glmm.pos))
qqnorm(resid(glmm.nb))
qqline(resid(glmm.nb))
qqnorm(resid(glmm.nb2))
qqline(resid(glmm.nb2))
```

\n
All three models failed to converge but negative binomial distributions looks nice n snug. Lets look into it further


```{r glmm.nb-summary, cache=TRUE}
summary(glmm.nb)
summary(glmm.nb2)
```
\n
As expected the standardisation doesn't actually affect model fit but rather improves interpretation... oh hold on was this just for binary response variables? I cant remember so will stick to the untransformed data for now.

\n
\n
\n
\n
\n

##### Negative binomial generalised linear mixed effects models for number of snails collected per survey - minimising model

Its obvi that the model is struggling to fit the data so I'll take the liberty to remove a few variables that **I** feel are "less" important


```{r glmer-BgBn_number-nb-min-models, message=FALSE, warning=FALSE, cache=TRUE}
glmm.nb.min.1 <- glmer.nb(BgBn_number ~ wbtype2 + wlevel + type +
                          temp + ph + (1|shehia/site), data=siteDF)

glmm.nb.min.2 <- glmer.nb(BgBn_number ~ wbtype2 + type + survey +
                          temp + (1|shehia/site), data=siteDF)

glmm.nb.min.3 <- glmer.nb(BgBn_number ~ wlevel + type + survey +
                          temp + (1|shehia/site), data=siteDF)

glmm.nb.min.4 <- glmer.nb(BgBn_number ~ wlevel + survey +
                          temp + (1|shehia/site), data=siteDF)

# qq plots 
qqnorm(resid(glmm.nb))
qqline(resid(glmm.nb))
qqnorm(resid(glmm.nb.min.1))
qqline(resid(glmm.nb.min.1))
qqnorm(resid(glmm.nb.min.2))
qqline(resid(glmm.nb.min.2))
qqnorm(resid(glmm.nb.min.3))
qqline(resid(glmm.nb.min.3))
qqnorm(resid(glmm.nb.min.4))
qqline(resid(glmm.nb.min.4))
```

\n
I think model 3 shows a very nice n shug fit although the others aren't too bad either. Lets look at whether they converged:



```{r glmer-BgBn_number-nb-min-models-summary, message=FALSE, warning=FALSE, cache=TRUE}
# summary
anova(glmm.nb.min.1, glmm.nb.min.2, glmm.nb.min.3, glmm.nb.min.3)
```
Right so model 1-3 reached convergence (whilst 4 did not) in the end and model three has the best fit - as good if not better than the original maximal maodel - and the best (i.e.) lowest ACI among the models that reached convergence. 

### Final model
First I'll do a quick overview and then go through factor by factor


#### Overview

```{r glmm.nb.min.3-Overview, cache=TRUE}
require(effects)
plot(allEffects(glmm.nb.min.3))
summary(glmm.nb.min.3)
```
\n
\n

#### Temperature
**temp**: Among the temperatures tested here (range: 22.33-37.40C) increasing temperatures have a statistically significant negative effect on snail abundance. After back-transforming, (exp(-0.17426) = 0.8400784; exp((exp(-0.17426+0.08534))-0.8400784) = 0.0748404), the effect of temperature on snial abundnace is such that with every one degree increase in temperature, a survey will on average have 0.8400784 (+-0.0748404) snails, i.e. on average -15.99552% (+-8.908729%) snails with every one degree C increase in temperature *(these were caclated as follows: (exp(-0.17426)-1)x100, and (exp(0.08534)-1)x100)* 
\n
\n




#### Water level
**wlevel**: The effect of watre level on snail abundance is statistically significantly linear and negative (since the wlevel.L term is significant whilst the wlevel.Q term (water level quadratic) is not). I.e. the effect of water level on snail abundance follows this equation: exp(8.48248) + wlevel.L x 0.3626526 (that last number is from exp(-1.01431)). In other words, ON AVERAGE, there is a -63.73474% ((exp(-1.01431)-1)*100) DECREASE FROM "1" to "2", and from "2" to "3". HOWEVER, although the model says that is a statistically significant negative trend, snail abundance is not statistically different between the three water level factors tested here (cos its ecology and varies etc etc). See that SEs and Confidence limits overlap below. Not a problem tho because overall, you know that there is a statistically significant negative trends going from "1" to "2" to "3" :) 
\n
\n
```{r glmm.nb.min.3-wlevel, cache=TRUE}
require(emmeans)
emmeans(glmm.nb.min.3, c("wlevel"), data = siteDF, type = "response")
```
\n
\n

#### Type
**Type**: The effect of type on snail abundance is statistically significantly negatively linear AND negatively quadratic! (since the Type.L and Type.Q terms are significant). In other words, going from "HNR" to "HD" to "LNR" to "LD", snail abindance decreases and this decrease accelerates at a certain point (thus the significant quadratic term). It is obvious from the plots above and when comparing individual factor levels (see below) that "HNR", "HD" and "LNR" are not statsistically different from eachother BUT "LD" has lower snail abundance than any of the other three "types" and its statistically significant in terms of non-overlapping SEs/CLs. 
```{r glmm.nb.min.3-type, cache=TRUE}
require(emmeans)
emmeans(glmm.nb.min.3, c("type"), data = siteDF, type = "response")
```


#### Survey
**Survey**: survey 2, 3 and 4 are stat diff from survey 1 according to the mdoel (see summary(glmm.nb.min.3) above) and thre three surveys have FEWER snails than survey 1. Comparing survey 2, 3 and 4 (see SEs and CLs below) it's cear that there is not a statistically significant difference between snail abundance among suveys 2, 3 and 4 (which is in line with top plot too).
\n
```{r glmm.nb.min.3-survey, cache=TRUE}
require(emmeans)
emmeans(glmm.nb.min.3, c("survey"), data = siteDF, type = "response")
```


\n


## Proportion of tested snails infected - IGNORE

Lets first turn the Sh_prev column into proportions and then have a look at the response variable
```{r respvar-PropInfected, cache=TRUE}
# Create a column with proportion of infected snails among the ones tested
siteDF$Sh_prop <- siteDF$Sh/siteDF$Bulinus_xeno
# 141 suveys have NaN (surveys where no snails were collected as dividing 0 by 0 gives NaN)

# Create a second column where NaN (surveys where no snails were collected) are converted to zeros
siteDF$Sh_prop2 <- siteDF$Sh_prop
siteDF$Sh_prop2[is.nan(siteDF$Sh_prop2)] <- 0

# remove surveys that were not conducted
siteDF <- siteDF[complete.cases(siteDF[ , "Sh_prop2"]),]


require(ggplot2)
p <- ggplot(siteDF,aes(x=Sh_prop))+
  stat_count(position="identity",alpha=0.5,width = .01)+theme()
p <- p + labs(y = "Density",x = "Proportion of infected snails") + 
  ggtitle("Not including NaNs (no snails collected)")

q <- ggplot(siteDF,aes(x=Sh_prop2))+
  stat_count(position="identity",alpha=0.5,width = .01)+theme()
q <- q + labs(y = "Density",x = "Proportion of infected snails") + 
  ggtitle("including NaNs as zeroes")

p
q
```
\n
Very zero inflated


##### Generalised linear mixed effects model for proportion of tested snails found to be infected

```{r glmer-Sh_prop, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
library(arm)

# Binomial
glmm.bin <- glmer(Sh_prop ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) + arm::rescale(cond) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))



#require(devtools)
#devtools::install_github("glmmTMB/glmmTMB/glmmTMB")
require(glmmTMB)

# Beta binomial
glmm.beta.bin <- glmmTMB(Sh_prop ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) + arm::rescale(cond) +
                 (1|shehia/site), weights=BgBn_number, data=siteDF,
                family=betabinomial(link = "logit"))


summary(glmm.bin)
summary(glmm.beta.bin)
```
\n
glmm.bin1 did not converge as a maximal model whilst glmm.beta.bin did. However, im not sure about how the second functiuon actually works... So lets try to minimise glmm.bin1 until we get something. "cond" is the least significant factor so lets remove that first.



```{r glmm.min.1-Sh_prop, message=FALSE, warning=FALSE, cache=TRUE}
glmm.bin.min.1 <- glmer(Sh_prop ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.1)
```
Still not converging - the second "least" significant varaible is "survey" so that goes next 



```{r glmm.min.2-Sh_prop, message=FALSE, warning=FALSE, cache=TRUE}
glmm.bin.min.2 <- glmer(Sh_prop ~ wbtype2 + wlevel + type +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.2)
```
\n
Still not converging so the next to go is "type"

```{r glmm.min.3-Sh_prop, message=FALSE, warning=FALSE, cache=TRUE}
glmm.bin.min.3 <- glmer(Sh_prop ~ wbtype2 + wlevel + 
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.3)
```
\n
Wooho! Final model for Sh_pres. Lets do the same for sh_pres2

```{r glmer-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
library(arm)

# Binomial
glmm.bin_prop2 <- glmer(Sh_prop2 ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) + arm::rescale(cond) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin_prop2)
```

\n
"cond" is the least significant factor so lets remove that first.

```{r glmm.min.1-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
glmm.bin.min.1_prop2 <- glmer(Sh_prop2 ~ wbtype2 + wlevel + type + survey +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.1_prop2)
```
\n
Still not converging so the next to go is "survey" and "type"

```{r glmm.min.2-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
glmm.bin.min.2_prop2 <- glmer(Sh_prop2 ~ wbtype2 + wlevel +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.2_prop2)
```

\n


Still not converging so the next to go is "wbtype2" and lets compare with the Sh_prop output

```{r glmm.min.3-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
require(lme4)
require(arm)
glmm.bin.min.3_prop2 <- glmer(Sh_prop2 ~ wlevel +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"))

summary(glmm.bin.min.3_prop2)
summary(glmm.bin.min.3)
```
\n


### Final model

**Conclusions**  

The two models are nearly identical regardless of whether surveys with no snails collected were included (i.e. proportion of snails infected is 0) or not so I suggest to go for the model that does not treat surveys witout snails as 0 proportion of snails colleted cos its mathematically impossible heh. Lets look at the summary again
```{r summary-glmm.min.3-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
summary(glmm.bin.min.3_prop2)
```
\n


- temp: increasing temperature increases proportion of snails infected   
- ph: increasing ph decreases proportion of snails infected   
- wlevel:   
1. Remember the factor order goes 1<2<3   
2. Intercept is the mean factor level, in the case factor "2" = -5.8058  
3. wlevel.L = measure of linear trends. It is positive and significant suggesting a linear increasing trend (although slowly as the estimate is only 0.6136) in logit across wlevels   
4. wlevel.Q = measure of quadratic trend and is negative (-1.6374) and significant this suggesting a deacceleration trend in the pattern of logits across wlevels   
5. Therefore, your model in the R output would be: logit(Sh_prop2) = -5.8058 + 0.6136 x wlevel.L + -1.6374 x wlevel.Q   
\n
\n
Lets take a look at what this looks like pltted and at the actual trend and use the contrasts argument of glmer, which specifies the parameters as the differences between successive levels. 


```{r wlevel-glmm.min.3-Sh_prop2, message=FALSE, warning=FALSE, cache=TRUE}
(coef(glmer(Sh_prop2 ~ wlevel +
                 arm::rescale(temp) + arm::rescale(ph) +
                 (1|shehia/site), weights=BgBn_number, 
                 data=siteDF, family = binomial(link = "logit"),
           contrasts=list(wlevel=MASS::contr.sdif))))$shehia


library(ggplot2)
ggplot((na.omit(siteDF)), aes(as.numeric(wlevel), logit(Sh_prop2))) + geom_point() +
  geom_smooth()
```
\n

Righty!   
\n
- As mentioned, the intercept is the mean and in this case factor "2" = -5.8058   
- The difference between "2" and "1" is 2.439275 so factor "1" = -5.8058 + 2.439275 = -8.245075   
- The difference between "3" and "2" is -1.571486 so factor "3" = -5.8058 + -1.571486 = -7.377286   
- I.e. all w.levels have a significantly negative effect on logit(Sh_prop2), but the negative effect is gretaer in water level 2 copared to 1 and in water level 2 compared to 3 whilst wlevel "1" is highest/best/closest to zero and wlevel "2" is worst/most negative. This trend is reflected in the plot whis **DOES NOT** show the actual equation line but still gives an indication   



# Snail-level analyses

```{r load-data, cache=TRUE, warning=FALSE, message=FALSE}
# Snail - gen test
df1 <- read.csv("../Data/TempTom/snail_data_xeno_v1.csv")

# Survey - environmetal variables + human activities
df2 <- read.csv("../Data/TempTom/survey_site_data_xeno_v1.csv")

# Region (Shehia) - schisto prevalence among school childern per region
df3 <- read.csv("../Data/TempTom/shehia_school_data_v1.csv")

# Site - HELP!! - This is total snail (df1?) summarised by site as total over study period?
df4 <- read.csv("../Data/TempTom/site_data_xeno_v1.csv")

## Set Snail variables as factors
df1$`snail_id`<-as.factor(df1$`snail_id`)
df1$`site`<-as.factor(df1$`site`)
df1$`survey`<-as.factor(df1$`survey`)
df1$`shehia`<-as.factor(df1$`shehia`)
df1$`type`<-as.factor(df1$`type`)
df1$`zest_arm`<-as.factor(df1$`zest_arm`)
df1$`survey_site`<-as.factor(df1$`survey_site`)
df1$`survey_shehia`<-as.factor(df1$`survey_shehia`)
df1$`wbtype`<-as.factor(df1$`wbtype`)
df1$`wbtype2`<-as.factor(df1$`wbtype2`)
df1$`assumed_Bulinus_spp_site`<-as.factor(df1$`assumed_Bulinus_spp_site`)
df1$`ITS-1-2-F_outcome`<-as.factor(df1$`ITS_1_2_F_outcome`)
df1$prepat_schisto_sp<-as.factor(df1$prepat_schisto_sp)
df1$prepat_Sh<-as.factor(df1$prepat_Sh)
df1$prepat_Sb<-as.factor(df1$prepat_Sb)
df1$prepat_ShSb<-as.factor(df1$prepat_ShSb)
df1$prepat_Schisto<-as.factor(df1$prepat_Schisto)
df1$Sh_all<-as.character(df1$Sh_all)
df1$Sh_all<-as.integer(df1$Sh_all)
df1$Sb_all<-as.character(df1$Sb_all)
df1$Sb_all<-as.integer(df1$Sb_all)
df1$'ITSF_2_outcome'<-as.factor(df1$'ITSF_2_outcome')
## have excluded the seq code columns for now could remove ##
df1$'conf_Bulinus_sp'<-as.factor(df1$'conf_Bulinus_sp')
df1$'Bulinus_haplo'<-as.factor(df1$'Bulinus_haplo')
df1$patent_Sh<-as.factor(df1$patent_Sh)
df1$patent_Sb<-as.factor(df1$patent_Sb)
df1$patent_Schisto<-as.factor(df1$patent_Schisto)

# NB can check that variables converted to factor by #
print(is.factor(df1$snail_id))

## Set Site Survey variables as factors
df2$`site`<-as.factor(df2$`USI`)
df2$`survey`<-as.factor(df2$`survey`)
df2$`shehia`<-as.factor(df2$`shehia`)
df2$`type`<-as.factor(df2$`type`)
df2$`zest_arm`<-as.factor(df2$`zest_arm`)
df2$`survey_site`<-as.factor(df2$`survey_site`)
df2$`survey_shehia`<-as.factor(df2$`survey_shehia`)
df2$`wbtype`<-as.factor(df2$`wbtype`)
df2$`wbtype2`<-as.factor(df2$`wbtype2`)
df2$`wlevel`<-as.factor(df2$`wlevel`)
df2$`BgBn_pres`<-as.factor(df2$`BgBn_pres`)
df2$`cerc_sp`<-as.factor(df2$`cerc_sp`)
df2$`flow`<-as.factor(df2$`flow`)
df2$`depth`<-as.factor(df2$`depth`)
df2$`Bfor_pres`<-as.factor(df2$`Bfor_pres`)
df2$`Lym_pres`<-as.factor(df2$`Lym_pres`)
df2$`Mel_pres`<-as.factor(df2$`Mel_pres`)
df2$`Cleo_pres`<-as.factor(df2$`Cleo_pres`)
df2$`Pila_pres`<-as.factor(df2$`Pila_pres`)
df2$`Lan_pres`<-as.factor(df2$`Lan_pres`)
df2$`Thiara_pres`<-as.factor(df2$`Thiara_pres`)
df2$`other_snail`<-as.factor(df2$`other_snail`)
df2$`Lilies`<-as.factor(df2$`Lilies`)
df2$`rushes`<-as.factor(df2$`rushes`)
df2$`rice`<-as.factor(df2$`rice`)
df2$waterhyacinth<-as.factor(df2$waterhyacinth)
df2$palmfronds<-as.factor(df2$palmfronds)
df2$sedge<-as.factor(df2$sedge)
df2$grass<-as.factor(df2$grass)
df2$banana<-as.factor(df2$banana)
df2$veg_any<-as.factor(df2$veg_any)
df2$mud<-as.factor(df2$mud)
df2$sand<-as.factor(df2$sand)
df2$rock<-as.factor(df2$rock)
df2$concrete<-as.factor(df2$concrete)
df2$roots<-as.factor(df2$roots)
df2$Litter<-as.factor(df2$Litter)
df2$`Dead.wood`<-as.factor(df2$`Dead.wood`)
df2$wudu<-as.factor(df2$wudu)
df2$bathing<-as.factor(df2$bathing)
df2$clothes<-as.factor(df2$clothes)
df2$dishes<-as.factor(df2$dishes)
df2$carbike<-as.factor(df2$carbike)
df2$collectingwater<-as.factor(df2$collectingwater)
df2$swimmingplaying<-as.factor(df2$swimmingplaying)
df2$fishing<-as.factor(df2$fishing)
df2$Ricecult<-as.factor(df2$Ricecult)
df2$otherfarming<-as.factor(df2$otherfarming)
df2$sanitation<-as.factor(df2$sanitation)
df2$water_contact<-as.factor(df2$water_contact)
df2$cow<-as.factor(df2$cow)
df2$goat<-as.factor(df2$goat)
df2$donkey<-as.factor(df2$donkey)
df2$ungulate<-as.factor(df2$ungulate)


## Set shehia school as factors
df3$`shehia`<-as.factor(df3$`shehia`)
df3$`type`<-as.factor(df3$`type`)
df3$`zest_arm`<-as.factor(df3$`zest_arm`)

## Set site data as factors
df4$`site`<-as.factor(df4$`USI`)
df4$`shehia`<-as.factor(df4$`shehia`)
df4$`type`<-as.factor(df4$`type`)
df4$`zest_arm`<-as.factor(df4$`zest_arm`)
df4$`wbtype`<-as.factor(df4$`wbtype`)
df4$`wbtype2`<-as.factor(df4$`wbtype2`)
df4$S1_BgBn_pres<-as.factor(df4$S1_BgBn_pres)
df4$S2_BgBn_pres<-as.factor(df4$S2_BgBn_pres)
df4$S3_BgBn_pres<-as.factor(df4$S3_BgBn_pres)
df4$S4_BgBn_pres<-as.factor(df4$S4_BgBn_pres)
df4$num_BgBn_pres<-as.factor(df4$num_BgBn_pres)
df4$all_BgBn_pres<-as.factor(df4$all_BgBn_pres)
# remainder are numerics #





#### Merging datasets for further analysis ####

## merge snail_data with survey_site data ##

# perfrom merge
merge(df1, df2, by.x="survey_site", by.y="survey_site", all.x=TRUE) -> mdf1
# write csv
write.csv(mdf1, "../Data/TempTom/mdf1.csv")

## merge mdf1 data with shehia (schistosomiasis prevalence) data 
# perform merge
merge(mdf1, df3, by.x="shehia.x", by.y="shehia", all.x=TRUE) -> mdf2
write.csv(mdf2, "../Data/TempTom//mdf2.csv")

#### KEEPING COLUMNS of interest FOR MODELS ####

# created new df with only the columns of interest #

df = mdf2[c("shehia.x", "survey_site", "snail_id", "site.x", "survey.x", "type.x", "zest_arm.x", 
            "survey_shehia.x", "wbtype.x", "wbtype2.x", "lat_Cor", "lon_Cor", "assumed_Bulinus_spp_site", 
            "Sh_all", "Sb_all", "wlevel", "BgBn_number", 
            "temp", "ph", "cond", "tds", "do", "sal", "flow", "depth", 
            "Bfor_pres", "Lym_pres", "Mel_pres", "Cleo_pres", "Pila_pres", "Lan_pres", "Thiara_pres", 
            "other_snail", 
            "Lilies", "rushes", "rice", "waterhyacinth", "palmfronds", "sedge", "grass", "banana", 
            "veg_any", "mud", "sand", "rock", "concrete", "roots", "Litter", "Dead.wood", 
            "wudu", "bathing", 
            "clothes", "dishes", "carbike", "collectingwater", "swimmingplaying", "fishing", "Ricecult", 
            "otherfarming", "sanitation", "water_contact",
            "cow", "goat", "donkey", "ungulate",
            "prev_2012", "prev_2013", "prev_2014", "prev_2015", "prev_2016",
            "eggs_2012", "eggs_2013", "eggs_2014", "eggs_2015", "eggs_2016",
            "prev_change_12_16", "eggs_change_12_16")]

# also created a na.omit df, however can specifiy this in the models
df.na <- na.omit(df)

# also created a data set removing the 'low values' sites Mat12 Mat7 Wam7 Ole13 Waw5 Uku10 
library(Hmisc)
library(dplyr)
df.na.rem1 <- filter(df.na, site.x != "Mat7")
df.na.rem2 <- filter(df.na.rem1, site.x != "Mat12")
df.na.rem3 <- filter(df.na.rem2, site.x != "Wam7")
df.na.rem4 <- filter(df.na.rem3, site.x != "Ole13")
df.na.rem5 <- filter(df.na.rem4, site.x != "Waw5")
df.na.rem <- filter(df.na.rem5, site.x != "Uku10")
library(effects)

# creating ordered variables for type and wlevel (as for other models)
df.na.rem$type.x <- factor(df.na.rem$type.x, ordered = TRUE, 
                                levels = c("HNR", "HD", "LNR", "LD"))
df.na.rem$wlevel <- factor(df.na.rem$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))


```


### Final model

```{r glmer1.17, message=FALSE, warning=FALSE, cache=TRUE}
library(arm)

df.na.glmer1.17 <- glmer(Sh_all ~ (1|shehia.x/site.x) +
                           wlevel + temp + ph,
                            data = df.na.rem, 
                         family = binomial(link = "logit"),
                         glmerControl("bobyqa"))


AF1 <- allFit(df.na.glmer1.17, verbose=T)
```




#### Overview

Chapter 7.4 of this https://bookdown.org/schmettow/NewStats/GLM.html was brilliant at explaining hot to interpret these outputs!!!!

```{r (df.na.glmer1.17-Overview, cache=TRUE}
require(effects)
plot(allEffects(df.na.glmer1.17))
summary(df.na.glmer1.17)
```
\n
\n




#### Water level
**wlevel**: The effect of water level on whether snails are infected or not is statistically significantly positively linear AND negatively quadratic! (since the wlevel.L and wlevel.Q terms are significant). In other words, going from "1" to "2" to "3", the probability of snails being infected increases BUT due to the negative quadratic term, we know that the rate of increase in probability of infection decreases and becomes a negative trend at a certain point. From above plot, its  obvious that "2" has most infections, i.e. infection rate increases from "1" to "2" and decreases from "2" to "3". We can use the "emmeans" to get the estimated probability of snails being infected in each of the water level types and the function automatically back-transforms estimates for us. For instance, the probability of a snail being infected in water level "1" is 0.00132 (+-0.000732)/0.132% of snails are infected.
```{r df.na.glmer1.17-wlevel, cache=TRUE}
require(emmeans)
emmeans(df.na.glmer1.17, c("wlevel"), data = df.na.rem, type = "response")
```


\n
\n


#### Temperature
**temp**: Temperature has a statistically significant positive effect on whether snails are infected, i.e. with increasing temperatures snails are more likely ti be infected. Averaged over the different water levels, as temperature increases by one degree celsius, the odds of snails being infected increase by a factor of 1.249233 (exp(0.22253))/ increase by 24.9233% (+- 6.3564% (exp(0.22253+0.04963)-exp(0.22253)*100)).

E.g. see below that at 27.5 degrees C, the probability of any given snail being infected is 0.00431; therefore, at 28.5 degrees, the odds of a snail being infected is 0.005384194 (0.00431*1.249233)
\n
```{r df.na.glmer1.17-temp, cache=TRUE}
require(emmeans)
emmeans(df.na.glmer1.17, c("temp"), data = df.na.rem, type = "response")
exp(0.22253)
```



#### ph
**pH**: ph has a statistically significant negative effect on whether snails are infected, i.e. with increasing ph snails are less likely to be infected. Averaged over the different water levels, as ph increases by one unit, the odds of snails being infected decrease by a factor of 0.4326224 (exp(-0.83789))/ decrease by 56.73776% (1-0.4326224 x 100).

E.g. see below that at ph = 7.01, the probability of asnail being infected is 0.00431; therefore, at ph = 8.01, the odds of a snail being infected is 0.001864603 (0.00431*0.4326224)
\n
```{r df.na.glmer1.17-ph, cache=TRUE}
require(emmeans)
emmeans(df.na.glmer1.17, c("ph"), data = df.na.rem, type = "response")
exp(-0.83789)*100
```


\n
\n

# Spatial autocorrelation
\n
\n
## Site-level analyses 


```{r spatial-corr-site-level, cache=TRUE}
require(gstat)
require(lme4)
require(sp)

# load data
df <- read.csv("../Data/TempTom/df2_new.csv")

# Subset columns of interest
keeps2 <- c("shehia", "USI", "survey", "lat_cor", "lon_cor", "BgBn_number", 
            "wlevel", "type", "temp")
siteDF_coord <- df[keeps2]

siteDF_coord$site <- as.factor(siteDF_coord$USI)
siteDF_coord$survey <- as.factor(siteDF_coord$survey)
siteDF_coord$shehia <- as.factor(siteDF_coord$shehia)
siteDF_coord$type <- factor(siteDF_coord$type, ordered = TRUE, 
                                levels = c("HNR", "HD", "LNR", "LD"))
siteDF_coord$wlevel <- factor(siteDF_coord$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))
# Remove NAs
siteDF_coord <- na.omit(siteDF_coord)
dim(siteDF_coord)

# Find residuals from response variable of final model
E <- residuals(glmm.nb.min.3, type = "response")

siteDF_res <- data.frame(E, siteDF_coord$lat_cor, siteDF_coord$lon_cor)

coordinates(siteDF_res) <- c("siteDF_coord.lat_cor", "siteDF_coord.lon_cor")

bubble(siteDF_res, "E", col = c("black", "grey"),
       main = "Residuals", xlab = "X-coordinates",
       ylab = "Y-coordinates")

Vario1 <- variogram(E ~ 1, siteDF_res)
plot(Vario1)
```


## Snail-level analyses

```{r spatial-corr-snail-level, cache=TRUE, warning=FALSE, message=FALSE}
require(gstat)
require(lme4)
require(sp)

# Snail - gen test
df1 <- read.csv("../Data/TempTom/snail_data_xeno_v1.csv")

# Survey - environmetal variables + human activities
df2 <- read.csv("../Data/TempTom/survey_site_data_xeno_v1.csv")

# Region (Shehia) - schisto prevalence among school childern per region
df3 <- read.csv("../Data/TempTom/shehia_school_data_v1.csv")

## Set Snail variables as factors
df1$`snail_id`<-as.factor(df1$`snail_id`)
df1$`site`<-as.factor(df1$`site`)
df1$`survey`<-as.factor(df1$`survey`)
df1$`shehia`<-as.factor(df1$`shehia`)
df1$`type`<-as.factor(df1$`type`)
df1$`zest_arm`<-as.factor(df1$`zest_arm`)
df1$`survey_site`<-as.factor(df1$`survey_site`)
df1$`survey_shehia`<-as.factor(df1$`survey_shehia`)
df1$`wbtype`<-as.factor(df1$`wbtype`)
df1$`wbtype2`<-as.factor(df1$`wbtype2`)
df1$`assumed_Bulinus_spp_site`<-as.factor(df1$`assumed_Bulinus_spp_site`)
df1$`ITS-1-2-F_outcome`<-as.factor(df1$`ITS_1_2_F_outcome`)
df1$prepat_schisto_sp<-as.factor(df1$prepat_schisto_sp)
df1$prepat_Sh<-as.factor(df1$prepat_Sh)
df1$prepat_Sb<-as.factor(df1$prepat_Sb)
df1$prepat_ShSb<-as.factor(df1$prepat_ShSb)
df1$prepat_Schisto<-as.factor(df1$prepat_Schisto)
df1$Sh_all<-as.character(df1$Sh_all)
df1$Sh_all<-as.integer(df1$Sh_all)
df1$Sb_all<-as.character(df1$Sb_all)
df1$Sb_all<-as.integer(df1$Sb_all)
df1$'ITSF_2_outcome'<-as.factor(df1$'ITSF_2_outcome')
## have excluded the seq code columns for now could remove ##
df1$'conf_Bulinus_sp'<-as.factor(df1$'conf_Bulinus_sp')
df1$'Bulinus_haplo'<-as.factor(df1$'Bulinus_haplo')
df1$patent_Sh<-as.factor(df1$patent_Sh)
df1$patent_Sb<-as.factor(df1$patent_Sb)
df1$patent_Schisto<-as.factor(df1$patent_Schisto)

# NB can check that variables converted to factor by #
print(is.factor(df1$snail_id))

## Set Site Survey variables as factors
df2$`site`<-as.factor(df2$`USI`)
df2$`survey`<-as.factor(df2$`survey`)
df2$`shehia`<-as.factor(df2$`shehia`)
df2$`type`<-as.factor(df2$`type`)
df2$`zest_arm`<-as.factor(df2$`zest_arm`)
df2$`survey_site`<-as.factor(df2$`survey_site`)
df2$`survey_shehia`<-as.factor(df2$`survey_shehia`)
df2$`wbtype`<-as.factor(df2$`wbtype`)
df2$`wbtype2`<-as.factor(df2$`wbtype2`)
df2$`wlevel`<-as.factor(df2$`wlevel`)
df2$`BgBn_pres`<-as.factor(df2$`BgBn_pres`)
df2$`cerc_sp`<-as.factor(df2$`cerc_sp`)
df2$`flow`<-as.factor(df2$`flow`)
df2$`depth`<-as.factor(df2$`depth`)
df2$`Bfor_pres`<-as.factor(df2$`Bfor_pres`)
df2$`Lym_pres`<-as.factor(df2$`Lym_pres`)
df2$`Mel_pres`<-as.factor(df2$`Mel_pres`)
df2$`Cleo_pres`<-as.factor(df2$`Cleo_pres`)
df2$`Pila_pres`<-as.factor(df2$`Pila_pres`)
df2$`Lan_pres`<-as.factor(df2$`Lan_pres`)
df2$`Thiara_pres`<-as.factor(df2$`Thiara_pres`)
df2$`other_snail`<-as.factor(df2$`other_snail`)
df2$`Lilies`<-as.factor(df2$`Lilies`)
df2$`rushes`<-as.factor(df2$`rushes`)
df2$`rice`<-as.factor(df2$`rice`)
df2$waterhyacinth<-as.factor(df2$waterhyacinth)
df2$palmfronds<-as.factor(df2$palmfronds)
df2$sedge<-as.factor(df2$sedge)
df2$grass<-as.factor(df2$grass)
df2$banana<-as.factor(df2$banana)
df2$veg_any<-as.factor(df2$veg_any)
df2$mud<-as.factor(df2$mud)
df2$sand<-as.factor(df2$sand)
df2$rock<-as.factor(df2$rock)
df2$concrete<-as.factor(df2$concrete)
df2$roots<-as.factor(df2$roots)
df2$Litter<-as.factor(df2$Litter)
df2$`Dead.wood`<-as.factor(df2$`Dead.wood`)
df2$wudu<-as.factor(df2$wudu)
df2$bathing<-as.factor(df2$bathing)
df2$clothes<-as.factor(df2$clothes)
df2$dishes<-as.factor(df2$dishes)
df2$carbike<-as.factor(df2$carbike)
df2$collectingwater<-as.factor(df2$collectingwater)
df2$swimmingplaying<-as.factor(df2$swimmingplaying)
df2$fishing<-as.factor(df2$fishing)
df2$Ricecult<-as.factor(df2$Ricecult)
df2$otherfarming<-as.factor(df2$otherfarming)
df2$sanitation<-as.factor(df2$sanitation)
df2$water_contact<-as.factor(df2$water_contact)
df2$cow<-as.factor(df2$cow)
df2$goat<-as.factor(df2$goat)
df2$donkey<-as.factor(df2$donkey)
df2$ungulate<-as.factor(df2$ungulate)


## Set shehia school as factors
df3$`shehia`<-as.factor(df3$`shehia`)
df3$`type`<-as.factor(df3$`type`)
df3$`zest_arm`<-as.factor(df3$`zest_arm`)


#### Merging datasets for further analysis ####

## merge snail_data with survey_site data ##

# perfrom merge
merge(df1, df2, by.x="survey_site", by.y="survey_site", all.x=TRUE) -> mdf1
# write csv
write.csv(mdf1, "../Data/TempTom/mdf1.csv")

## merge mdf1 data with shehia (schistosomiasis prevalence) data 
# perform merge
merge(mdf1, df3, by.x="shehia.x", by.y="shehia", all.x=TRUE) -> mdf2
write.csv(mdf2, "../Data/TempTom//mdf2.csv")

#### KEEPING COLUMNS of interest FOR FINAL MODEL ####

# created new df with only the columns of interest #

df = mdf2[c("shehia.x", "site.x", "lat_Cor", "lon_Cor", 
            "Sh_all", "wlevel", "temp", "ph")]

# also created a na.omit df, however can specifiy this in the models
df.na <- na.omit(df)

# also created a data set removing the 'low values' sites Mat12 Mat7 Wam7 Ole13 Waw5 Uku10 
library(Hmisc)
library(dplyr)
df.na.rem1 <- filter(df.na, site.x != "Mat7")
df.na.rem2 <- filter(df.na.rem1, site.x != "Mat12")
df.na.rem3 <- filter(df.na.rem2, site.x != "Wam7")
df.na.rem4 <- filter(df.na.rem3, site.x != "Ole13")
df.na.rem5 <- filter(df.na.rem4, site.x != "Waw5")
df.na.rem <- filter(df.na.rem5, site.x != "Uku10")
library(effects)

# creating ordered variables for wlevel (as for other models)
df.na.rem$wlevel <- factor(df.na.rem$wlevel, ordered = TRUE, 
                                levels = c("1", "2", "3", "4"))

# run final model 
library(arm)
library(lme4)
df.na.glmer1.17 <- glmer(Sh_all ~ (1|shehia.x/site.x) +
                           wlevel + temp + ph,
                            data = df.na.rem, 
                         family = binomial(link = "logit"),
                         glmerControl("bobyqa"))



# Find residuals from response variable of final model
E <- residuals(df.na.glmer1.17, type = "response")

snailDF_res <- data.frame(E, df.na.rem$lat_Cor, df.na.rem$lon_Cor)

coordinates(snailDF_res) <- c("df.na.rem.lat_Cor", "df.na.rem.lon_Cor")

bubble(snailDF_res, "E", col = c("black", "grey"),
       main = "Residuals", xlab = "X-coordinates",
       ylab = "Y-coordinates")

Vario1 <- variogram(E ~ 1, snailDF_res)
plot(Vario1)
```







